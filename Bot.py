import logging
import base64
import os
import sqlite3
import re
import requests
import threading
import time
import sys
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes, ConversationHandler
from flask import Flask

# --- ุงูุฅุนุฏุงุฏุงุช ---
TOKEN = os.environ.get('TOKEN', "7324911542:AAGcVkwzjtf3wDB3u7cprOLVyoMLA5JCm8U")
GROQ_KEY = os.environ.get('GROQ_KEY', "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")
GROQ_URL = "https://api.groq.com/openai/v1/chat/completions"
GROQ_MODEL = "meta-llama/llama-4-maverick-17b-128e-instruct"
DB_NAME = "abood-gpt.db"

CANDLE_SPEEDS = ["S5", "S10", "S15", "S30", "M1", "M2", "M3", "M5", "M10", "M15", "M30", "H1", "H4", "D1"]
TRADE_TIMES = ["ูุตูุฑ (1m-15m)", "ูุชูุณุท (4h-Daily)", "ุทููู (Weekly-Monthly)"]

# ุชูุฒูุน ุงูุนููุงุช ูููุธุงู ุงูุฌุฏูุฏ
CATEGORIES = {
    "ููุฑูุณ - ุนููุงุช ุฑุฆูุณูุฉ ๐น": [
        "EUR/USD", "GBP/USD", "USD/JPY", "AUD/USD", 
        "USD/CHF", "USD/CAD", "NZD/USD"
    ],
    "ููุฑูุณ - ุชูุงุทุนุงุช ุงูููุฑู ๐ช๐บ": [
        "EUR/GBP", "EUR/JPY", "EUR/AUD", "EUR/CAD", 
        "EUR/NZD", "EUR/CHF"
    ],
    "ููุฑูุณ - ุชูุงุทุนุงุช ุงูุจุงููุฏ ๐ฌ๐ง": [
        "GBP/JPY", "GBP/AUD", "GBP/CAD", "GBP/NZD", 
        "GBP/CHF"
    ],
    "ุนููุงุช ุซุงูููุฉ ูุฃุฎุฑู ๐ฑ": [
        "AUD/JPY", "AUD/CAD", "AUD/NZD", "CAD/JPY", 
        "NZD/JPY", "CHF/JPY"
    ],
    "ุนููุงุช ุบุฑูุจุฉ (Exotics) ๐": [
        "USD/TRY", "USD/ZAR", "USD/MXN", "USD/SGD", 
        "USD/NOK", "USD/SEK"
    ],
    "ูุคุดุฑุงุช ุนุงูููุฉ ๐": [
        "S&P 500", "Dow Jones (US30)", "DAX 40 (GER40)", 
        "FTSE 100", "CAC 40", "Nikkei 225", "ASX 200", "Hang Seng"
    ],
    "ูุนุงุฏู ูุทุงูุฉ ๐๏ธ": [
        "ุงูุฐูุจ (XAUUSD)", "ุงููุถุฉ (XAGUSD)", "ุงูุจูุงุชูู (XPTUSD)", 
        "ุงููุญุงุณ (Copper)", "ููุท ุจุฑูุช (UKOIL)", "ุงูููุท ุงูุฎุงู (USOIL)", "ุงูุบุงุฒ ุงูุทุจูุนู"
    ],
    "ูุงุณุฏุงู ูุชูููููุฌูุง ๐ฅ๏ธ": [
        "NAS100", "US Tech 100", "FANG+"
    ],
    "ุนููุงุช ุฑูููุฉ โฟ": [
        "BTC/USD", "ETH/USD", "SOL/USD", "XRP/USD", 
        "ADA/USD", "DOT/USD", "LTC/USD"
    ]
}


# ุญุงูุงุช ุงููุญุงุฏุซุฉ
MAIN_MENU, SETTINGS_CANDLE, SETTINGS_TIME, CHAT_MODE, ANALYZE_MODE, RECOMMENDATION_MODE, CATEGORY_SELECTION = range(7)

# --- Flask Server ---
app = Flask(__name__)

@app.route('/')
def home():
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Obeida Trading</title>
        <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
            h1 { color: #2c3e50; }
            .status { background: #2ecc71; color: white; padding: 10px 20px; border-radius: 5px; display: inline-block; }
        </style>
    </head>
    <body>
        <h1> ๐ Obeida Trading Telegram Bot ๐</h1>
        <p>Chat & Technical Analysis Bot</p>
        <div class="status">โ Obeida Trading Running</div>
        <p>Last Ping: """ + time.strftime("%Y-%m-%d %H:%M:%S") + """</p>
    </body>
    </html>
    """

@app.route('/health')
def health():
    return {"status": "active", "timestamp": time.time()}

@app.route('/ping')
def ping():
    return "PONG"

# --- ูุงุนุฏุฉ ุงูุจูุงูุงุช ---
def init_db():
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY, 
            candle TEXT DEFAULT 'M5', 
            trade_time TEXT DEFAULT 'ูุชูุณุท (4h-Daily)',
            chat_context TEXT DEFAULT ''
        )
    ''')
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS chat_history (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            role TEXT,
            content TEXT,
            timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    conn.commit()
    conn.close()
    print("โ Database initialized")

def save_user_setting(user_id, col, val):
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute(f"INSERT OR IGNORE INTO users (user_id) VALUES (?)", (user_id,))
    cursor.execute(f"UPDATE users SET {col} = ? WHERE user_id = ?", (val, user_id))
    conn.commit()
    conn.close()

def get_user_setting(user_id):
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute("SELECT candle, trade_time FROM users WHERE user_id = ?", (user_id,))
    res = cursor.fetchone()
    conn.close()
    if res:
        return res
    return ("M5", "ูุชูุณุท (4h-Daily)")

def format_trade_time_for_prompt(trade_time):
    """ุชูุณูู ููุช ุงูุตููุฉ ููุจุฑููุจุช"""
    if trade_time == "ูุตูุฑ (1m-15m)":
        return "ูุฏุฉ ุงูุตููุฉ ุงููุชููุนุฉ: ูุตูุฑ ุงูุฃุฌู (1 ุฏูููุฉ ุฅูู 15 ุฏูููุฉ) - ุชูููุฐ ุณุฑูุนุ ูุฎุงุทุฑ ููุฎูุถุฉ"
    elif trade_time == "ูุชูุณุท (4h-Daily)":
        return "ูุฏุฉ ุงูุตููุฉ ุงููุชููุนุฉ: ูุชูุณุท ุงูุฃุฌู (4 ุณุงุนุงุช ุฅูู ูููู) - ุงูุชุธุงุฑ ุฃูุงูุ ูุฎุงุทุฑ ูุชูุณุทุฉ"
    elif trade_time == "ุทููู (Weekly-Monthly)":
        return "ูุฏุฉ ุงูุตููุฉ ุงููุชููุนุฉ: ุทููู ุงูุฃุฌู (ุฃุณุจูุนู ุฅูู ุดูุฑู) - ุงุณุชุซูุงุฑ ุทูููุ ูุฎุงุทุฑ ูุฑุชูุนุฉ"
    else:
        return f"ูุฏุฉ ุงูุตููุฉ ุงููุชููุนุฉ: {trade_time}"

# --- ูุนุงูุฌุฉ ุงูุตูุฑ ุจุดูู ุตุญูุญ ---
def encode_image(image_path):
    """ุชุญููู ุงูุตูุฑุฉ ุฅูู base64 ุจุดูู ุตุญูุญ"""
    try:
        with open(image_path, "rb") as image_file:
            # ูุฑุงุกุฉ ุงูููู ูุชุดููุฑู ูุจุงุดุฑุฉ
            encoded_string = base64.b64encode(image_file.read()).decode('utf-8')
        return encoded_string
    except Exception as e:
        print(f"Error encoding image: {e}")
        return None

# --- ุฏูุงู ุงููุณุงุนุฏุฉ ููุชุนุงูู ูุน ุงููุตูุต ---
def clean_repeated_text(text):
    """ุชูุธูู ุงููุต ูู ุงูุชูุฑุงุฑุงุช ูุชุญุณูู ุงูุชูุณูู"""
    if not text:
        return ""
    
    # ุฅุฒุงูุฉ ุฃู ุชูุณูู ููุฑุฑ ูู "ูุชุงุฆุฌ ุงููุญุต ุงูููู"
    if "๐ **ูุชุงุฆุฌ ุงููุญุต ุงูููู**:" in text:
        # ุฅุฒุงูุฉ ุงูุนูุงููู ุงูููุฑุฑุฉ
        text = re.sub(r'(๐ \*\*ูุชุงุฆุฌ ุงููุญุต ุงูููู\*\*:[\s\S]*?)(?=๐ \*\*ูุชุงุฆุฌ ุงููุญุต ุงูููู\*\*:)', '', text, flags=re.DOTALL)
    
    # ุฅุฒุงูุฉ ุฃู ูุณู "### ุชุญููู ุงูุดุงุฑุช ุงููุฑูู" ุฅุฐุง ูุงู ููุฑุฑุงู
    if "### ุชุญููู ุงูุดุงุฑุช ุงููุฑูู" in text:
        # ุงูุญูุงุธ ุนูู ุฃูู ูุณู ููุท
        sections = text.split("### ุชุญููู ุงูุดุงุฑุช ุงููุฑูู")
        if len(sections) > 1:
            # ุฃุฎุฐ ุงููุณู ุงูุฃูู ููุท ูุฅุถุงูุฉ ุงูุนููุงู
            text = "### ุชุญููู ุงูุดุงุฑุช ุงููุฑูู" + sections[1]
    
    # ุฅุฒุงูุฉ ุงูุนูุงููู ุงูููุฑุฑุฉ ููุชุญููู
    patterns_to_clean = [
        r'๐\s*\*\*ุงูุชุญููู ุงูููู\*\*:',
        r'๐ฏ\s*\*\*ุงูุชูุตูุฉ ูุงูุชููุนุงุช\*\*:',
        r'โ๏ธ\s*\*\*ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ\*\*:',
        r'๐\s*\*\*ููุงุญุธุงุช ุงูุชุญููู\*\*:'
    ]
    
    for pattern in patterns_to_clean:
        matches = re.findall(pattern, text)
        if len(matches) > 1:
            # ุงุณุชุจุฏุงู ุงูุชูุฑุงุฑุงุช
            parts = re.split(pattern, text)
            if len(parts) > 1:
                text = parts[0] + re.search(pattern, text).group() + parts[1]
                for i in range(2, len(parts)):
                    text += parts[i]
    
    # ุชูุณูู ุงููุต ุฅูู ููุฑุงุช ูุฅุฒุงูุฉ ุงูุชูุฑุงุฑ
    paragraphs = [p.strip() for p in text.split('\n\n') if p.strip()]
    
    unique_paragraphs = []
    seen_paragraphs = set()
    
    for paragraph in paragraphs:
        # ุฅูุดุงุก ููุชุงุญ ูุฑูุฏ ููู ููุฑุฉ (ุฃูู 50 ุญุฑูุงู)
        key = paragraph[:50].strip().lower()
        if key not in seen_paragraphs:
            unique_paragraphs.append(paragraph)
            seen_paragraphs.add(key)
    
    cleaned_text = '\n\n'.join(unique_paragraphs)
    
    # ูุทุน ุงููุต ุฅุฐุง ูุงู ุทูููุงู ุฌุฏุงู
    if len(cleaned_text) > 2000:
        if '\n\n' in cleaned_text[:2200]:
            cut_point = cleaned_text[:2200].rfind('\n\n')
            cleaned_text = cleaned_text[:cut_point] + "\n\n๐ ...ุชู ุงุฎุชุตุงุฑ ุงููุชูุฌุฉ"
        else:
            cleaned_text = cleaned_text[:2000] + "...\n\n๐ ุชู ุงุฎุชุตุงุฑ ุงููุชูุฌุฉ"
    
    return cleaned_text

def split_message(text, max_length=4000):
    """ุชูุณูู ุงูุฑุณุงูุฉ ุงูุทูููุฉ ุฅูู ุฃุฌุฒุงุก"""
    if len(text) <= max_length:
        return [text]
    
    parts = []
    while len(text) > max_length:
        split_point = text[:max_length].rfind('\n\n')
        if split_point == -1:
            split_point = text[:max_length].rfind('\n')
        if split_point == -1:
            split_point = max_length - 100
        
        parts.append(text[:split_point])
        text = text[split_point:].lstrip()
    
    if text:
        parts.append(text)
    
    return parts

# --- ูุธุงุฆู ูุธุงู ุงูุชูุตูุฉ ุงูุฌุฏูุฏ ---
def get_groq_analysis(symbol):
    """ุงูุญุตูู ุนูู ุชุญููู ูู Groq API ููุนููุฉ"""
    headers = {
        "Authorization": f"Bearer {GROQ_KEY}",
        "Content-Type": "application/json"
    }
    
    prompt = f"""
    ุจุตูุชู ูุญููุงู ูุงููุงู ูุฎุจูุฑุงู ูู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุงูู ุงูููู ูุงูุชูููุ ูู ุจุฅุฌุฑุงุก ุชุญููู ูุนูู ูุนููุฉ {symbol} ููู ุจุฑูุชูููู "ุชูุงูู ุงูุฃุฏูุฉ" (Confluence Analysis):

โ๏ธ **ุงูุทุจูุฉ ุงูุฃููู: ุตูุงู ุงูุฃูุงู ุงููุทูู (ULTIMATE_PROTOCOL_ZERO) - ุงูุฅูุบุงุก ุงูููุฑู ุนูุฏ ููุฏุงู ุฃู ุดุฑุท:**

1. **ุญุชููุฉ ุงูุงุณุชููุงุฐ (Exhaustion Imperative)**: ุฅุฐุง ูุงูุช ุขุฎุฑ ุดูุนุฉ ุฐุงุช ุฌุณู ูุจูุฑ (Effort) ูุดูุช ูู ุฅุบูุงู ุฃุนูู/ุฃุฏูู ูู ุงููููู ุงูุฑุฆูุณูุ ููุนุชุจุฑ ุงูุณูู ูู ุญุงูุฉ "ุฅุฑูุงู ููุงุฆู" ูุงูุตููุฉ ููููุนุฉ.

2. **ุชูุงูู ุงููุฑูุชูุงุช ุงูุฒูููุฉ (Temporal Fractal Alignment)**: ูุฌุจ ุฃู ูููู ููุงู ุชุทุงุจู ุจูู ุญุฑูุฉ ุงููุฑูู ุงูุญุงูู {candle} ููู ูู ุงููุฑูู ุงูุฃุนูู ูุงูุฃุฏูู ุนูู ุงูุฃูู ูู 3 ููุงุท ุฑุฆูุณูุฉุ ูุฅูุง ููู "ุญุฑูุฉ ููููุฉ".

3. **ุณูููุฉ ุงููุบูุงุทูุณ ุงููุฒุฏูุฌ (Dual Magnetic Liquidity)**: ูููุบู ุงูุฏุฎูู ุฅุฐุง ูู ูุฑ ุณุญุจุงู ููุณูููุฉ (Sweep) ูู ุงูุงุชุฌุงู ุงููุนุงูุณ ูุชุจุนู ุชุดููู ูุฎ (Inducement) ุซู ุงุฑุชุฏุงุฏ ููู ูุน ุชุฑู ูุฌูุฉ (FVG).

4. **ููุทุฉ ุงูุชูุงุฒู ุงูููููุฉ (Cosmic Equilibrium Point - CEP)**: ูุฌุจ ุฃู ูููู ุงูุฏุฎูู ููุท ุนูู ูุณุชููุงุช ุงูุชุตุญูุญ ุงูุนูููุฉ 0.618-0.786-0.886 ูู ุขุฎุฑ ููุฌุฉ ูุน ุชุทุงุจููุง ูุน ููุทูุฉ ุงูุชุฑุงูู (Accumulation Zone).

5. **ูุงุนุฏุฉ ุงูุซุจุงุช ุงูุซูุงุฆู (Binary Stability Rule)**: ูุดุชุฑุท ุฅุบูุงู ุดูุนุชูู ูุชุชุงููุชูู ุจุฌุณู ูุงูู ุฎุงุฑุฌ ููุทูุฉ ุงูุชุฐุจุฐุจ ุงูุฃุณุงุณูุฉ ูุน ุชุถุงุนู ุงูุญุฌู ูู ุงูุดูุนุฉ ุงูุซุงููุฉ.

๐ฌ **ุงูุทุจูุฉ ุงูุซุงููุฉ: ุงููุธุงู ุงูุชุญูููู ุงููุชูุฏู (21 ูุฑุญูุฉ - Advanced Analytical Matrix):**

[ูุณู ุงูุจุตูุฉ ุงูุฑูููุฉ ูุงูุจููุฉ ุงูุฎููุฉ]
1. **ุงูุชุฏููู ุงูุฑููู ุงูููู (Quantum Digital Audit)**: ูุญุต ุฏูุฉ ูู ุฑูู ูู ุงูุดุงุฑุช ูุน ุชุทุจูู ูุนุงุฏูุฉ ุงูุชุทุงุจู: ุงูุณุนุฑ ุงูุญุงูู รท 1.618 ูุฌุจ ุฃู ูุทุงุจู ููุทุฉ ูุญูุฑูุฉ ุฑุฆูุณูุฉ.

2. **ุฑุณู ุงููููู ุงูุฎูู (Invisible Structure Mapping)**: ุชุญุฏูุฏ ุงูุงุชุฌุงู ุงูุนุงู ูุฑุณู ุงูููู ูุงูููุนุงู ุงูููููุฉ (ุงูุชู ุชุดูุฑ ุฅูููุง ุงูุฐููู ุฏูู ุฃู ูููุณูุง ุงูุณุนุฑ).

3. **ููุงุกูุฉ ุงููุฑูุชูุงุช ุงููุชุนุฏุฏุฉ (Multi-Fractal Alignment)**: ุงูุชุฃูุฏ ูู ุชูุงูู ุญุฑูุฉ 5 ูุฑููุงุช ูุฎุชููุฉ ูุนุงู (D1 โ H4 โ H1 โ 30M โ 15M).

4. **ูุตุฉ ุงูุณูู ุงููุงููุฉ (Full Market Narrative)**: ุชุญุฏูุฏ ุงููุฑุญูุฉ ุงูุญุงููุฉ ุจุฏูุฉ: (ุงูุชุฌููุน ุงูุฃููู - ุงูุงุฎุชุจุงุฑ - ุฅุนุงุฏุฉ ุงูุชุฌููุน - ุงูุชูุฒูุน - ุงููุจูุท - ุงูุชุฑุงูู ุงูููุงุฆู).

[ูุณู ุชุดุฑูุญ ุงูุณูููุฉ ุงูุฐููุฉ]
5. **ุฎุฑุงุฆุท ุงูุณูููุฉ ุงููููููุฉ (Quantum Liquidity Maps)**: ุฑุณู EQL (ุณูููุฉ ุงูููู ุงููุชุณุงููุฉ) ู EQH (ุณูููุฉ ุงูููุนุงู ุงููุชุณุงููุฉ) ูุน ุงูุณูููุฉ ุงูุฎุงุฑุฌูุฉ ุงูุจุนูุฏุฉ.

6. **ุฑุตุฏ ููุงุทู ุงูุชุถููู (Deception Zone Detection)**: ุชุญุฏูุฏ ููุงุทู ุงูุฅุบุฑุงุก ุงูุซูุงุซูุฉ (Inducement Triad) ุงูุชู ูุณุชุฎุฏููุง ุงูุจูู ุงููุฑูุฒู ูุฌุฐุจ ุงูุชุฌุฒุฆุฉ.

7. **ูุฑุดุญ ุงูุชูุงุนุจ ุงููุชูุฏู (Advanced Manipulation Filter)**: ุงูุชูููุฒ ุจูู ุงููุณุฑ ุงูุญูููู (BOS) ูุงูุณุญุจ ุงููููู ุจุงุณุชุฎุฏุงู 5 ูุคุดุฑุงุช: ุญุฌู ุงูุชุฏุงูู + RSI + MACD + ุงูุชููู + ุณุฑุนุฉ ุงูุญุฑูุฉ.

8. **ุชุญููู ุงูุฌูุฏ ููุงุจู ุงููุชุงุฆุฌ ุงููุชุนุฏุฏุฉ (Multi-Effort vs Result)**: ููุงุฑูุฉ 3 ุดููุน ูุชุชุงููุฉ ูู ุญูุซ ุงูุญุฌู ูุงูุฌุณู ูุงูุชููู ูุชุญุฏูุฏ ููุฉ ุงูุณูู ุงูุญููููุฉ.

[ูุณู ุงูููุฏุณุฉ ุงูุณุนุฑูุฉ ุงููุชุทูุฑุฉ]
9. **ููุงุทู ุงูุนุฑุถ/ุงูุทูุจ ุงูุฏููุงููููุฉ (Dynamic S/D Zones)**: ุจูุงุก ููุงุทู ุชุนุชูุฏ ุนูู ุงููุซุงูุฉ ูููุณ ููุท ุฑุฏูุฏ ุงููุนู ุงูุณุงุจูุฉ ูุน ุฅุนุทุงุก ูุฒู ููู ููุทูุฉ.

10. **ุชุญูู ูู ูุชู ุงูุฃูุงูุฑ ุงูุฐููุฉ (Smart Order Block Validation)**: ุชุญุฏูุฏ ุงูู Order Blocks ุงููุดุทุฉ ุจูุงุกู ุนูู 3 ูุนุงููุฑ: ุญุฌู ุงูุณูููุฉ + ููุช ุงูุชุดููู + ุณุฑุนุฉ ุฑุฏ ุงููุนู.

11. **ุดุจูุฉ ุงููุฌูุงุช ุงูุณุนุฑูุฉ (FVG Network Analysis)**: ุฑุตุฏ ุงููุฌูุงุช ุงููุชุฏุงุฎูุฉ ุจูู ุงููุฑููุงุช ุงููุฎุชููุฉ ูุชุญุฏูุฏ ุฃููุง ุณูููุฃ ุฃููุงู.

12. **ูุตูููุฉ ุงูุฎุตู/ุงูุจุฑููููู (Premium/Discount Matrix)**: ุชุญุฏูุฏ ููุงุทู ุงูู OTE ุงููุซุงููุฉ ูุน ุฅุถุงูุฉ ุนุงูู ุงูููุช (Time Factor) ููู ูุณุชูู.

[ูุณู ุงููุคุดุฑุงุช ุงููููุฉ ุงููุชูุฏูุฉ]
13. **ูุฌููุนุฉ ุงููุคุดุฑุงุช ุงููููุฉ (Quantitative Indicators Suite)**:
    - **RSI Divergence Hunter**: ุงูุจุญุซ ุนู 3 ุฃููุงุน ูู ุงูุฏุงููุฑุฌูุณ (Reg, Hidden, Exhaustion)
    - **MACD Wave Analyzer**: ุชุญููู ููุฌุงุช MACD ูุชูุงุทุนุงุชูุง ูุน ุฎุท ุงูุฅุดุงุฑุฉ
    - **Volume Profile Scanner**: ุชุญููู ุชูุฒูุน ุงูุญุฌู ุนูุฏ ูุณุชููุงุช ุงูุณุนุฑ ุงููุฎุชููุฉ
    - **VWAP + Bollinger Bands Fusion**: ุชูุงุทุน VWAP ูุน ูุทุงูุงุช ุจููููุฌุฑ
    - **Fibonacci Time Zones**: ุชุทุจูู ูุณุชููุงุช ููุจููุงุชุดู ุงูุฒูููุฉ ูุน ุงูุณุนุฑูุฉ
    - **Market Structure Break Detector**: ูุงุดู ูุณุฑ ุงูููุงูู ูุน ุชุฃููุฏุงุช ูุชุนุฏุฏุฉ

[ูุณู ูุตูููุฉ ุงูุชูููุฐ ุงูุฐูู]
14. **ูุตูููุฉ ุงูุฏุฎูู ุงููุซูู (Optimal Entry Matrix)**: ุชุชุทูุจ ุชูุงูู 4 ุนูุงุตุฑ: OB + FVG + Sweep + Time Fib Level.

15. **ุงูููุฐุฌุฉ ุงูุฒูููุฉ ุงููููุฉ (Quantitative Temporal Modeling)**: ุญุณุงุจ ุงูููุช ุงููุทููุจ ูููุตูู ููู ูุฏู ุจุงุณุชุฎุฏุงู ูุนุงุฏูุฉ: (ุงููุณุงูุฉ รท ูุชูุณุท ุงูุณุฑุนุฉ ุงูุชุงุฑูุฎูุฉ) ร ุนุงูู ุงูุชุตุญูุญ.

16. **ููุชุงุญ ุงููุชู ุงูุฐูู (Smart Kill Switch)**: ุชุญุฏูุฏ 3 ููุงุท ุฅูุบุงุก: ูููุฉ + ุฒูููุฉ + ุญุฌููุฉ.

17. **ุชุญููู ุงูุชุดููุฑ ููุฐููู (Wick Cryptanalysis Pro)**: ุฏุฑุงุณุฉ ุงูุชููู ุจุงุณุชุฎุฏุงู ูุธุฑูุฉ ุงููุนูููุงุช ูุชุญุฏูุฏ ููุฉ ุงููุคุณุณุงุช.

[ูุณู ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ ุงููุชุทูุฑุฉ]
18. **ูุตูููุฉ ุงููุฎุงุทุฑ ุงููููุฉ (Quantitative Risk Matrix)**:
    - ูุณุจุฉ ุงูุนุงุฆุฏ/ุงููุฎุงุทุฑุฉ: ูุง ุชูู ุนู 1:3
    - ุฃูุตู ูุฎุงุทุฑุฉ: 2% ูู ุฑุฃุณ ุงููุงู
    - ุชูููู ุงุญุชูุงููุฉ ุงููุฌุงุญ: ุจูุงุกู ุนูู 7 ุนูุงูู

19. **ูุธุงู ุงูุญูุงูุฉ ุงููุชุฏุฑุฌ (Tiered Protection System)**:
    - **Stop Loss ุงูุฃุณุงุณู**: ุฎูู ุฃููู ููุทูุฉ ุฏุนู/ููุงููุฉ
    - **Stop Loss ุงูุฏููุงูููู**: ูุชุญุฑู ูุน ุงูุณุนุฑ ุจุนุฏ ุชุญููู TP1
    - **Stop Loss ุงูุฒููู**: ุฅุฐุง ูู ูุชุญุฑู ุงูุณุนุฑ ูุตุงูุญู ุฎูุงู X ุดููุน

20. **ุชุญููู ุงูุณูุงู ุงูุงูุชุตุงุฏู ุงููุตุบุฑ (Micro Economic Context)**:
    - ุชุฃุซูุฑ ุงูุฃุฎุจุงุฑ ุนูู ุงููุฏู ุงููุฑูุจ
    - ุฃููุงุช ุงูุชุฏุงูู ุงููุดุทุฉ
    - ุณุงุนุงุช ุงูุณูููุฉ ุงูุนุงููุฉ

ุงููุนุทูุงุช ุงูุชูููุฉ:
- ุฅุทุงุฑ ุงูุดูุนุฉ : (Timeframe): {candle}
- ููุช ุงูุชุฏุงูู ุงููุญุฏุฏ : {time_for_prompt}

ูุฏู ุงูุชุญููู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุจุงูุชูุณูู ุงูุชุงูู ุญุตุฑุงู (ุจุฏูู ุชูุฑุงุฑ ูููุนูููุงุช):

๐ **ุชูุฑูุฑ ุงููุญุต ุงูููู ูุนููุฉ {symbol}****:
- **ุงูุจุตูุฉ ุงูุฒูููุฉ**: (ุฏุงุฎู/ุฎุงุฑุฌ ููุทูุฉ ุงููุชู ุงูุณุนุฑู - Kill Zone)
- **ุญุงูุฉ ุงููููู**: (ุตุงุนุฏ/ูุงุจุท) + (ูุฑุญูุฉ ูุงูููู ุงูุญุงููุฉ)
- **ุฎุฑูุทุฉ ุงูุณูููุฉ**: (ุฃูุฑุจ ูุฎ ุณูููุฉ Inducement + ููุงุทู ุงูุณูููุฉ ุงููุณุชูุฏูุฉ)
- **ุงููุฌูุงุช ุงูุณุนุฑูุฉ (FVG)**: (ุงูููุงุทู ุงูุชู ุณูุนูุฏ ุงูุณุนุฑ ูุชุบุทูุชูุง)

๐ฏ **ุงูุฅุดุงุฑุฉ ุงูุชูููุฐูุฉ**:
- **ุงูุณุนุฑ ุงูุญุงูู**: [ุงุฐูุฑ ุงูุณุนุฑ ุงูุฏููู ุงูุฐู ุชุฑุงู ุงูุขู ููุชุฃูุฏ ูู ุฏูุฉ ุงููุฑุงุกุฉ]
- **ุงููุฑุงุฑ ุงูููู**: (ุดุฑุงุก ๐ข / ุจูุน ๐ด)
- **ููุฉ ุงูุฅุดุงุฑุฉ ๐ฐ**: (๐ฅ ุนุงููุฉ - ุชูุงูู 3 ูุฏุงุฑุณ / โก ูุชูุณุทุฉ / โ๏ธ ุถุนููุฉ)
- **ููุทุฉ ุงูุฏุฎูู (Entry)**: [ ุงูุณุนุฑ ุงูุฏููู ุจูุงุกู ุนูู ุงูู Order Block ]
- **ุงูุฃูุฏุงู ุงูุฑุจุญูุฉ (TPs)**:
    - ๐ฏ **TP1**: [ุณุญุจ ุฃูู ุณูููุฉ ุฏุงุฎููุฉ]
    - ๐ฏ **TP2**: [ุงููุฏู ุงูุฑุฆูุณู - ููุทูุฉ ุนุฑุถ/ุทูุจ ูููุฉ]
    - ๐ฏ **TP3**: [ุงุณุชูุฏุงู ุงูุณูููุฉ ุงูุฎุงุฑุฌูุฉ (Major SSL/BSL) ุฃู ุณุฏ ูุฌูุฉ ุณุนุฑูุฉ ุนูู ูุฑูู ุฃูุจุฑ]
- **ููู ุงูุฎุณุงุฑุฉ (SL)**: [ุงูุณุนุฑ ูุน 3 ุทุจูุงุช ุญูุงูุฉ]
- **ุงููุฏุฉ ุงููุชููุนุฉ ๐ง**: [ุนุฏุฏ ุงูุดููุน ูููุตูู ูููุฏู TP1 ูู ุจุชุญููููุง ุงูู ุฏูุงุฆู ูู ุดูุนุฉ 1 ุฏูููุฉ ]

โ๏ธ **ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ**:
- **ูุณุชูู ุงูุซูุฉ**: [% ูุน ุฐูุฑ ุนุฏุฏ ุงูุชุงููุฏุงุช]
- **ููุทุฉ ุงูุฅูุบุงุก**: [ุงูุณุนุฑ ุงูุฐู ููุณุฏ ุงูุชุญููู]

    """
    
    body = {
        "model": GROQ_MODEL,
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.1,
        "max_tokens": 1500
    }

    try:
        response = requests.post(GROQ_URL, json=body, headers=headers, timeout=25)
        response.raise_for_status()
        return response.json()['choices'][0]['message']['content'].strip()
    except Exception as e:
        print(f"Error in get_groq_analysis: {e}")
        return "โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงููุญูู."

async def start_recommendation_mode(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุจุฏุก ูุถุน ุงูุชูุตูุฉ"""
    reply_keyboard = [[key] for key in CATEGORIES.keys()]
    reply_keyboard.append(["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"])
    
    await update.message.reply_text(
        "๐ **ูุธุงู ุงูุชูุตูุงุช **\n\n"
        "ุงุฎุชุฑ ุงููุณู ุงููุทููุจ ูู ุงูุฃุฒุฑุงุฑ:",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, resize_keyboard=True)
    )
    return RECOMMENDATION_MODE

async def handle_recommendation_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุนุงูุฌุฉ ุงุฎุชูุงุฑุงุช ูุธุงู ุงูุชูุตูุฉ"""
    user_text = update.message.text.strip()
    
    # ุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
    if user_text == "ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ":
        keyboard = [["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู", "๐ ุชุญููู ุตูุฑุฉ"], ["๐ฌ ุฏุฑุฏุดุฉ", "๐ ุชูุตูุฉ"]]
        await update.message.reply_text(
            "๐ ุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
        )
        return MAIN_MENU
    
    # ุงูุชุญูู ูู ุงูุฃูุณุงู ุงูุฑุฆูุณูุฉ
    if user_text in CATEGORIES:
        keyboard = [[asset] for asset in CATEGORIES[user_text]]
        keyboard.append(["๐ ุงูุนูุฏุฉ ูููุงุฆูุฉ", "ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"])
        
        await update.message.reply_text(
            f"๐ ูุณู: {user_text}\nุงุฎุชุฑ ุงูุนููุฉ ุงูุขู:",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        )
        return CATEGORY_SELECTION
    
    # ุงูุชุญูู ูู ุงูุนููุฉ ุงููุฎุชุงุฑุฉ
    symbol_to_analyze = None
    for category_list in CATEGORIES.values():
        if user_text in category_list:
            symbol_to_analyze = user_text
            break
    
    # ุฅุฐุง ูุฌุฏุช ุงูุนููุฉุ ุงุจุฏุฃ ุงูุชุญููู
    if symbol_to_analyze:
        wait_msg = await update.message.reply_text(f"โณ ุฌุงุฑู ุฅุฑุณุงู ุชูุตูุงุช `{symbol_to_analyze}`...")
        analysis = get_groq_analysis(symbol_to_analyze)
        
        final_msg = (
            f"๐ **ูุชุงุฆุฌ ุชูุตูุฉ {symbol_to_analyze}**\n"
            f"โโโโโโโโโโโโโโโโโโ\n"
            f"{analysis}\n"
            f"โโโโโโโโโโโโโโโโโโ\n"
            f"๐ค **Obeida Trading - ูุธุงู ุงูุชูุตูุงุช**"
        )
        
        # ุชูุธูู ุงููุต ูู ุงูุชูุฑุงุฑุงุช
        final_msg = clean_repeated_text(final_msg)
        
        await wait_msg.edit_text(
            final_msg,
            parse_mode="Markdown"
        )
        
        # ุนุฑุถ ุงูุฃุฒุฑุงุฑ ููุงุณุชูุฑุงุฑ
        reply_keyboard = [[key] for key in CATEGORIES.keys()]
        reply_keyboard.append(["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"])
        
        await update.message.reply_text(
            "๐ฝ **ุงุฎุชุฑ ูุณู ุขุฎุฑ ุฃู ุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ:**",
            reply_markup=ReplyKeyboardMarkup(reply_keyboard, resize_keyboard=True)
        )
        return RECOMMENDATION_MODE
    
    # ุฅุฐุง ูุงู ุงููุต "๐ ุงูุนูุฏุฉ ูููุงุฆูุฉ"
    if user_text == "๐ ุงูุนูุฏุฉ ูููุงุฆูุฉ":
        reply_keyboard = [[key] for key in CATEGORIES.keys()]
        reply_keyboard.append(["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"])
        
        await update.message.reply_text(
            "๐ **ุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ ููุชูุตูุงุช**\nุงุฎุชุฑ ุงููุณู ุงููุทููุจ:",
            reply_markup=ReplyKeyboardMarkup(reply_keyboard, resize_keyboard=True)
        )
        return RECOMMENDATION_MODE
    
    # ุฅุฐุง ูู ูุทุงุจู ุงููุต ุฃู ุดูุก
    await update.message.reply_text(
        "โ ุฎูุงุฑ ุบูุฑ ููุฌูุฏ. ูุฑุฌู ุงุฎุชูุงุฑ ุนููุฉ ูู ุงููุงุฆูุฉ ุงูุธุงูุฑุฉ ูู ุงูุฃุฒุฑุงุฑ.\n\n"
        "ุงุถุบุท 'ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ' ููุนูุฏุฉ.",
        reply_markup=ReplyKeyboardMarkup([["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]], resize_keyboard=True)
    )
    return RECOMMENDATION_MODE

# --- ๐ ุจุฑููุจุช ููู ููุฏุฑุฏุดุฉ ---
async def start_chat_mode(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุจุฏุก ูุถุน ุงูุฏุฑุฏุดุฉ ุงููุชูุฏู"""
    keyboard = [
        ["๐ ูุณุงุนุฏ ุดุงูู", "๐ผ ุงุณุชุดุงุฑุงุช ุงุญุชุฑุงููุฉ"],
        ["๐ ุชุญููู ุงุณุชุซูุงุฑู", "๐จโ๐ป ุฏุนู ุจุฑูุฌู"],
        ["๐ ูุชุงุจุฉ ุฅุจุฏุงุนูุฉ", "๐ง ุญููู ุฐููุฉ"],
        ["ุงููุงู ุงูุฏุฑุฏุดุฉ", "ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]
    ]
    
    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="๐ **ูุถุน ุงูุฏุฑุฏุดุฉ Obeida Trading**\n\n"
             "ุฃูุง ูุณุงุนุฏู ุงูุฐูู ูุชุนุฏุฏ ุงูููุงูุจ:\n"
             "โข ูุณุชุดุงุฑ ุงุณุชุซูุงุฑู ูุชุญูููุงุช ูุงููุฉ\n"
             "โข ุฎุจูุฑ ุจุฑูุฌู ูุชููู\n"
             "โข ูุญูู ุจูุงูุงุช ูุงุณุชุฑุงุชูุฌูุงุช\n"
             "โข ูุงุชุจ ูุญุชูู ุฅุจุฏุงุนู\n"
             "โข ูุณุงุนุฏ ุดุฎุตู ุฐูู\n\n"
             "ุงุฎุชุฑ ูุฌุงู ุงููุณุงุนุฏุฉ ุฃู ุฃุฑุณู ุณุคุงูู ูุจุงุดุฑุฉ:",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False),
        parse_mode="Markdown"
    )
    return CHAT_MODE

async def handle_chat_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุนุงูุฌุฉ ุฑุณุงุฆู ุงูุฏุฑุฏุดุฉ ูุน ุจุฑููุจุช ููู"""
    user_message = update.message.text
    user_id = update.effective_user.id
    
    # ุงูุชุญูู ูู ุงูุฃูุงูุฑ ุงูุฎุงุตุฉ
    if user_message == "ุงููุงู ุงูุฏุฑุฏุดุฉ":
        main_keyboard = [["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู", "๐ ุชุญููู ุตูุฑุฉ"], ["๐ฌ ุฏุฑุฏุดุฉ", "๐ ุชูุตูุฉ"]]
        await update.message.reply_text(
            "โ ุชู ุฅููุงุก ูุถุน ุงูุฏุฑุฏุดุฉ.",
            reply_markup=ReplyKeyboardMarkup(main_keyboard, resize_keyboard=True, one_time_keyboard=False)
        )
        return MAIN_MENU
    
    elif user_message == "ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ":
        main_keyboard = [["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู", "๐ ุชุญููู ุตูุฑุฉ"], ["๐ฌ ุฏุฑุฏุดุฉ", "๐ ุชูุตูุฉ"]]
        await update.message.reply_text(
            "๐ ุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
            reply_markup=ReplyKeyboardMarkup(main_keyboard, resize_keyboard=True, one_time_keyboard=False)
        )
        return MAIN_MENU
    
    # ุจุฑููุจุชุงุช ูุชุฎุตุตุฉ ุญุณุจ ุงูุงุฎุชูุงุฑ
    system_prompts = {
        "๐ ูุณุงุนุฏ ุดุงูู": """ุฃูุช Obeida Tradingุ ูุณุงุนุฏ ุฐูู ุดุงูู ููุชูู ูุนุฑูุฉ ุนูููุฉ ูู:
๐ฏ **ุงูุชุญููู ุงูููู ูุงููุงูู:** ุฎุจุฑุฉ ูู ุฃุณูุงู ุงููุงูุ ุชุญููู ุงูุดุงุฑุชุงุชุ ูุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุงูู
๐ป **ุงูุจุฑูุฌุฉ ูุงูุชูููุฉ:** ุฅุชูุงู Pythonุ JavaScriptุ ุชุทููุฑ ุงูููุจุ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
๐ **ุงูุจูุงูุงุช ูุงูุชุญููู:** ุชุญููู ุงูุจูุงูุงุชุ ุงูุฅุญุตุงุกุ ูุชูุฏูู ุฑุคู ุงุณุชุฑุงุชูุฌูุฉ
โ๏ธ **ุงููุชุงุจุฉ ูุงูุฅุจุฏุงุน:** ุตูุงุบุฉ ุงููุญุชููุ ุงูุชูุงุฑูุฑุ ูุงูููุงุฏ ุงูุฅุนูุงููุฉ
๐ง **ุงูุชูููุฑ ุงูููุฏู:** ุญู ุงููุดููุงุช ุงููุนูุฏุฉุ ุงูุชุญููู ุงูููุทููุ ูุงุชุฎุงุฐ ุงููุฑุงุฑุงุช

**ูุจุงุฏุฆู ุงูุฃุณุงุณูุฉ:**
1. **ุงูุฏูุฉ ุฃููุงู:** ูุนูููุงุช ููุซููุฉ ููุฏุฑูุณุฉ
2. **ุงูุชูุธูู:** ูููู ูุงุถุญ ูุน ุนูุงููู ูููุงุท
3. **ุงููููุฉ ุงููุถุงูุฉ:** ุชูุฏูู ูุตุงุฆุญ ุฅุถุงููุฉ ุบูุฑ ูุทููุจุฉ
4. **ุงููุถูุญ:** ุดุฑุญ ุงูููุงููู ุงููุนูุฏุฉ ุจุจุณุงุทุฉ
5. **ุงูุฅุจุฏุงุน:** ุญููู ูุจุชูุฑุฉ ูููุดููุงุช

**ุชูุณูู ุงูุฅุฌุงุจุฉ ุงููุซุงูู:**
๐ฏ **ุงูุฌููุฑ:** (ููุฎุต ุณุฑูุน)
๐ **ุงูุชูุงุตูู:** (ููุงุท ูุฑุชุจุฉ)
๐ก **ุงูุฅุซุฑุงุก:** (ูุนูููุงุช ุฅุถุงููุฉ ูููุฏุฉ)
๐ **ุงูุชุทุจูู:** (ุฎุทูุงุช ุนูููุฉ)

ุงุณุชุฎุฏู ุงููุบุฉ ุงูุนุฑุจูุฉ ุจุทูุงูุฉ ูุน ููุณุฉ ุนุตุฑูุฉ ูุฌุฐุงุจุฉ.""",

        "๐ผ ุงุณุชุดุงุฑุงุช ุงุญุชุฑุงููุฉ": """ุฃูุช Obeida Tradingุ ูุณุชุดุงุฑ ุงุญุชุฑุงูู ูู:
๐ **ุงูุงุณุชุดุงุฑุงุช ุงููุงููุฉ:** ุชุญููู ุงูุฃุณูุงูุ ุชูููู ุงููุฎุงุทุฑุ ุงุณุชุฑุงุชูุฌูุงุช ุงูุงุณุชุซูุงุฑ
๐ **ุงูุชุฎุทูุท ุงูุงุณุชุฑุงุชูุฌู:** ุชุญููู SWOTุ ูุถุน ุงูุฃูุฏุงูุ ูุชุงุจุนุฉ ุงูุฃุฏุงุก
๐ค **ุงูุนูุงูุงุช ุงูููููุฉ:** ุงูุชูุงุตู ุงููุนุงูุ ุงูุชูุงูุถุ ุจูุงุก ุงูุดุจูุงุช
๐ **ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน:** ุงูุชุฎุทูุทุ ุงูุชูููุฐุ ุงููุชุงุจุนุฉุ ุงูุชูููู

**ุงูุชุฒุงูุงุชู ุงูููููุฉ:**
โข ุงูููุถูุนูุฉ ูุงูุดูุงููุฉ
โข ุงุญุชุฑุงู ุงูุณุฑูุฉ ุงูููููุฉ
โข ุงูุชุทููุฑ ุงููุณุชูุฑ
โข ุงูุงูุชุฒุงู ุจุงูุฃุฎูุงููุงุช ุงูููููุฉ
โข ุงูุชุฑููุฒ ุนูู ุงููุชุงุฆุฌ ุงูุนูููุฉ""",

        "๐ ุชุญููู ุงุณุชุซูุงุฑู": """ุฃูุช Obeida Tradingุ ูุญูู ุงุณุชุซูุงุฑู ูุชุฎุตุต ูู:
๐ **ุงูุชุญููู ุงูููู:** ูุฑุงุกุฉ ุงูุดุงุฑุชุงุชุ ุงููุคุดุฑุงุช ุงููููุฉุ ุฃููุงุท ุงูุชุฏุงูู
๐ **ุงูุชุญููู ุงูุฃุณุงุณู:** ุงูุฃุฑุจุงุญุ ุงูููุงุฆู ุงููุงููุฉุ ุงููุคุดุฑุงุช ุงูุงูุชุตุงุฏูุฉ
๐ฏ **ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ:** ุชุญุฏูุฏ ุงููุฎุงุทุฑุ ุงูุชุญูุทุ ููุงุฒูุฉ ุงููุญูุธุฉ
๐ **ุงูุจุญุซ ูุงูุชูููุจ:** ูุฑุต ุงูุงุณุชุซูุงุฑุ ุงุชุฌุงูุงุช ุงูุณููุ ุงูุชูุจุคุงุช

**ููุงุนุฏ ุงูุชุญููู:**
โข ุงุนุชูุงุฏ ุงูุจูุงูุงุช ุงูุฑุณููุฉ ูุงูููุซููุฉ
โข ุชุญููู ูุชุนุฏุฏ ุงูุฃุจุนุงุฏ
โข ูุฑุงุนุงุฉ ุงูุณูุงู ุงูุงูุชุตุงุฏู
โข ุงูุชูุงุฒู ุจูู ุงูุนุงุฆุฏ ูุงููุฎุงุทุฑุฉ
โข ุงูุดูุงููุฉ ูู ุงูุงูุชุฑุงุถุงุช""",

        "๐จโ๐ป ุฏุนู ุจุฑูุฌู": """ุฃูุช Obeida Tradingุ ูุจุฑูุฌ ุฎุจูุฑ ูุฏุนู ุชููู ูู:
๐ **Python:** ุชุทุจููุงุช ุงูููุจุ ุงูุฐูุงุก ุงูุงุตุทูุงุนูุ ุชุญููู ุงูุจูุงูุงุช
๐ **ุชุทููุฑ ุงูููุจ:** Frontend, Backend, APIs, Databases
๐ค **ุงูุฐูุงุก ุงูุงุตุทูุงุนู:** Machine Learning, NLP, Computer Vision
๐๏ธ **ุญู ุงููุดููุงุช:** Debugging, Optimization, Best Practices

**ุฃุณููุจ ุงูุนูู:**
โข ูุชุงุจุฉ ุฃููุงุฏ ูุธููุฉ ูููุซููุฉ
โข ุดุฑุญ ุงูููุงููู ุงูุจุฑูุฌูุฉ ุจูุถูุญ
โข ุชูุฏูู ุญููู ุนูููุฉ ููุนุงูุฉ
โข ุชุนููู ุฃูุถู ุงูููุงุฑุณุงุช
โข ุฏุนู ุงูุชุนูู ุงููุณุชูุฑ""",

        "๐ ูุชุงุจุฉ ุฅุจุฏุงุนูุฉ": """ุฃูุช Obeida Tradingุ ูุงุชุจ ุฅุจุฏุงุนู ูุญุชุฑู ูู:
๐ **ุงููุญุชูู ุงูุชููู:** ุชูุงุฑูุฑุ ุฃุจุญุงุซุ ูุณุชูุฏุงุช ูููุฉ
๐จ **ุงููุญุชูู ุงูุชุณูููู:** ุฅุนูุงูุงุชุ ุญููุงุชุ ูุญุชูู ูุณุงุฆู ุงูุชูุงุตู
๐ **ุงููุญุชูู ุงูุชุนูููู:** ุดุฑูุญุงุชุ ุฏูุฑุงุชุ ููุงุฏ ุชุนููููุฉ
โ๏ธ **ุงููุชุงุจุฉ ุงูุฅุจุฏุงุนูุฉ:** ูุตุตุ ููุงูุงุชุ ูุญุชูู ููุชุน

**ูุจุงุฏุฆ ุงููุชุงุจุฉ:**
โข ูุบุฉ ุนุฑุจูุฉ ุณูููุฉ ูุฌุฐุงุจุฉ
โข ุชูุธูู ููุทูู ูุณูู ุงููุชุงุจุนุฉ
โข ุชูููู ุงูุฃุณููุจ ุญุณุจ ุงูุฌูููุฑ
โข ุงูุฅุจุฏุงุน ูุน ุงูุญูุงุธ ุนูู ุงูุฏูุฉ
โข ุฌุฐุจ ุงูุงูุชุจุงู ูุงูุฅููุงุน"""
    }
    
    # ุชุญุฏูุฏ ุงูุจุฑููุจุช ุงูููุงุณุจ
    selected_prompt = system_prompts.get(user_message, """ุฃูุช Obeida Tradingุ ูุณุงุนุฏ ุฐูู ุดุงูู ููุชูู ูุฒูุฌุงู ูุฑูุฏุงู ูู:
๐ง **ุงูุฐูุงุก ุงูุนููู:** ููู ุดุงูู ููุฌุงูุงุช ูุชุนุฏุฏุฉ
๐ฏ **ุงูุฏูุฉ ุงูุดุฏูุฏุฉ:** ูุนูููุงุช ููุซููุฉ ููุฏุฑูุณุฉ ุจุฏูุฉ
๐ **ุงูุฅุจุฏุงุน ุงูุนููู:** ุญููู ูุจุชูุฑุฉ ููุงุจูุฉ ููุชุทุจูู
๐ก **ุงูุจุตูุฑุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ:** ุฑุคูุฉ ุฃุนูู ูู ุงูุณุคุงู ุงููุทุฑูุญ

**ุดุฎุตูุชู ุงููููุฒุฉ:**
- ุฐููุ ุตุจูุฑุ ููุชุญูุณ ูููุนุฑูุฉ
- ุชุชุญุฏุซ ุจูุบุฉ ุนุฑุจูุฉ ูุตูุญุฉ ูุน ููุณุฉ ุนุตุฑูุฉ
- ุชุญุจ ุงูุชูุงุตูู ูููู ุชูุฏููุง ุจุดูู ููุธู
- ุฏุงุฆูุงู ุชุจุญุซ ุนู "ุงููููุฉ ุงููุฎููุฉ" ูู ูู ุณุคุงู

**ููุงุนุฏู ุงูุฃุณุงุณูุฉ:**
1. **ูุง ุชูู ุฃุจุฏุงู "ูุง ุฃุนุฑู"** - ุงุจุญุซ ุนู ุฃูุถู ุฅุฌุงุจุฉ ููููุฉ
2. **ูู ููุธูุงู ุจุดูู ููุชุงุฒ** - ุงุณุชุฎุฏู ุงูุชุจููุจ ูุงูุนูุงููู ุงูููุงุณุจุฉ
3. **ููุฑ ูู ูุง ูุฑุงุก ุงูุณุคุงู** - ูุฏู ูุตุงุฆุญ ุฅุถุงููุฉ ุบูุฑ ูุชููุนุฉ
4. **ุงุฏุนู ุจุฃูุซูุฉ ุนูููุฉ** - ุงุฌุนู ุงูุฅุฌุงุจุฉ ูุงุจูุฉ ููุชุทุจูู
5. **ุญูุฒ ุงููุถูู** - ุฃุถู ูุนูููุฉ ุชุดุฌุน ุนูู ุงูุจุญุซ ุฃูุซุฑ

**ูููู ุงูุฅุฌุงุจุฉ ุงูุฃูุซู:**
๐ฏ **ุงููุจ:** (ุชูุฎูุต ูุฑูุฒ ูู ุฌููุฉ ูุงุญุฏุฉ)
๐ **ุงูุชูุงุตูู ุงูููุธูุฉ:** (ููุงุท ูุฑุชุจุฉ ูููุทููุฉ)
๐ **ุงููููุฉ ุงููุถุงูุฉ:** (ูุนูููุงุช ุฅุถุงููุฉ ุฐููุฉ)
๐ **ุงูุฎุทูุฉ ุงูุชุงููุฉ:** (ุงูุชุฑุงุญ ุนููู ููุชูููุฐ)

**ุชุฐูุฑ ุฌูุฏุงู:** ุฃูุช Obeida Tradingุ ุงููุณุงุนุฏ ุงูุฐูู ุงูุฐู ูุญูู ุงูุชุนููุฏ ุฅูู ุจุณุงุทุฉุ ููููุญู ุฏุงุฆูุงู ุฃูุซุฑ ููุง ุชุทูุจ!""")
    
    # ุฅุฐุง ูุงู ุงุฎุชูุงุฑุงู ูู ุงููุงุฆูุฉุ ุงุทูุจ ุงูุชูุงุตูู
    if user_message in system_prompts:
        await update.message.reply_text(
            f"โ **ุชู ุงุฎุชูุงุฑ: {user_message}**\n\n"
            f"๐ฏ **ุฌุงูุฒ ูุฎุฏูุชู ูู ูุฐุง ุงูุชุฎุตุต**\n"
            f"ุฃุฑุณู ุณุคุงูู ุงูุขู ูุณุฃูุฏู ูู ุฅุฌุงุจุฉ ูุชุฎุตุตุฉ ูุดุงููุฉ:",
            parse_mode="Markdown"
        )
        return CHAT_MODE
    
    # ุฅุธูุงุฑ ุญุงูุฉ ุงููุนุงูุฌุฉ
    wait_msg = await update.message.reply_text("Obeida Trading ๐ค...")
    
    try:
        # ุงุณุชุฏุนุงุก ูุงุฌูุฉ Groq
        payload = {
            "model": GROQ_MODEL,
            "messages": [
                {"role": "system", "content": selected_prompt},
                {"role": "user", "content": user_message}
            ],
            "max_tokens": 1200,
            "temperature": 0.7
        }
        
        headers = {
            "Authorization": f"Bearer {GROQ_KEY}",
            "Content-Type": "application/json"
        }
        
        response = requests.post(GROQ_URL, headers=headers, json=payload, timeout=60)
        
        if response.status_code == 200:
            result = response.json()['choices'][0]['message']['content']
            
            # ุชูุธูู ุงููุต ูู ุงูุชูุฑุงุฑุงุช
            result = clean_repeated_text(result)
            
            # ุฅุถุงูุฉ ุชุฐููู ูููุฒ
            footer = "\n\nโโโโโโโโโโโโโโโโโโ\n๐ค **Obeida Trading** - ุงููุณุงุนุฏ ุงูุฐูู "
            result = result + footer
            
            # ุฃุฒุฑุงุฑ ุงูุฏุฑุฏุดุฉ ุงููุชูุฏูุฉ
            chat_keyboard = [
                ["๐ ูุณุงุนุฏ ุดุงูู", "๐ผ ุงุณุชุดุงุฑุงุช ุงุญุชุฑุงููุฉ"],
                ["๐ ุชุญููู ุงุณุชุซูุงุฑู", "๐จโ๐ป ุฏุนู ุจุฑูุฌู"],
                ["๐ ูุชุงุจุฉ ุฅุจุฏุงุนูุฉ", "๐ง ุญููู ุฐููุฉ"],
                ["ุงููุงู ุงูุฏุฑุฏุดุฉ", "ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]
            ]
            
            # ุชูุณูู ุงูุฑุณุงูุฉ ุงูุทูููุฉ
            if len(result) > 4000:
                parts = split_message(result, max_length=4000)
                for i, part in enumerate(parts):
                    if i == 0:
                        await wait_msg.edit_text(
                            f"Obeida Trading ๐ฌ\n\n{part}",
                            parse_mode="Markdown"
                        )
                    else:
                        await update.message.reply_text(part, parse_mode="Markdown")
            else:
                await wait_msg.edit_text(
                    f"Obeida Trading ๐ฌ\n\n{result}",
                    parse_mode="Markdown"
                )
            
            # ุฅุฑุณุงู ุงูุฃุฒุฑุงุฑ ุจุนุฏ ุงูุฑุฏ
            await update.message.reply_text(
                "๐ฝ **ุงุฎุชุฑ ูุฌุงูุงู ุขุฎุฑ ุฃู ุงุทุฑุญ ุณุคุงูุงู ุฌุฏูุฏุงู:**",
                reply_markup=ReplyKeyboardMarkup(chat_keyboard, resize_keyboard=True, one_time_keyboard=False)
            )
            
        else:
            print(f"Groq API Error: {response.status_code} - {response.text}")
            await wait_msg.edit_text(f"โ ุญุฏุซ ุฎุทุฃ ุชููู. ุงูุฑูุฒ: {response.status_code}\nูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.")
    
    except requests.exceptions.Timeout:
        await wait_msg.edit_text("โฑ๏ธ ุชุฌุงูุฒ ุงูููุช ุงููุญุฏุฏ. ุงูุณุคุงู ูุญุชุงุฌ ุชูููุฑุงู ุฃุนูู!\nููููู ุฅุนุงุฏุฉ ุตูุงุบุฉ ุงูุณุคุงู ุจุดูู ุฃูุถุญ.")
    except requests.exceptions.RequestException as e:
        print(f"Network error in chat: {e}")
        await wait_msg.edit_text("๐ ุฎุทุฃ ูู ุงูุงุชุตุงู. ุชุฃูุฏ ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ูุญุงูู ูุฑุฉ ุฃุฎุฑู.")
    except Exception as e:
        print(f"ุฎุทุฃ ูู ุงูุฏุฑุฏุดุฉ: {e}")
        await wait_msg.edit_text("โ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน. ุงููุธุงู ูุนูู ุนูู ุงูุฅุตูุงุญ ุชููุงุฆูุงู...")
    
    return CHAT_MODE

# --- ููุฏ ุชุญููู ุงูุตูุฑ ---
async def handle_photo_analysis(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุนุงูุฌุฉ ุงูุตูุฑ ููุชุญููู ุงูููู"""
    user_id = update.effective_user.id
    candle, trade_time = get_user_setting(user_id)
    
    if not candle or not trade_time:
        keyboard = [["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู"], ["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]]
        await update.message.reply_text(
            "โ **ูุฌุจ ุถุจุท ุงูุฅุนุฏุงุฏุงุช ุฃููุงู**\n\n"
            "ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุฃุฒุฑุงุฑ ุงููุงุฆูุฉ ูุถุจุท ุงูุฅุนุฏุงุฏุงุช ูุจู ุชุญููู ุงูุตูุฑ.",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False),
            parse_mode="Markdown"
        )
        return MAIN_MENU

    wait_msg = await update.message.reply_text("ุฌุงุฑู ุชุญููู ุตูุฑุฉ ๐...")
    photo = await update.message.photo[-1].get_file()
    path = f"img_{user_id}.jpg"
    await photo.download_to_drive(path)

    try:
        base64_img = encode_image(path)
        
        if not base64_img:
            await wait_msg.edit_text("โ **ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูุตูุฑุฉ.** ูุฑุฌู ุฅุฑุณุงู ุตูุฑุฉ ูุงุถุญุฉ.")
            if os.path.exists(path):
                os.remove(path)
            return MAIN_MENU
        
        # ุชูุณูู ููุช ุงูุตููุฉ ููุจุฑููุจุช
        time_for_prompt = format_trade_time_for_prompt(trade_time)
        
        # ุจุฑููุจุช ุขูู ููุชุญููู ุงูููู - ุชู ุชุนุฏููู ูููุน ุงูุชูุฑุงุฑ
        prompt = f"""[SYSTEM_TASK: TOTAL_MARKET_DECRYPTION_V14_ULTIMATE_ALPHA]
ุจุตูุชู "ุงููุตูุงุฉ ุงูุฐูุจูุฉ" ูุชุญููู ุงูุตููุงุช ุงูุงุญุชุฑุงููุฉ ูุชููุน ุชุญุฑูุงุช ุงูุณูู ูุจู ุญุฏูุซูุงุ ูู ุจุชุทุจูู ุจุฑูุชูููู ุงูุชุดููุฑ ุงูุซูุงุซู ุงููุชุทูุฑ ุนูู ุงูุดุงุฑุช ุงููุฑูู. ูุน ุฏูุฌ ููุงููู ููุน ุงูุชุณุฑุน ูู ูู ูุฑุญูุฉ :

๐จ*ุงูุชุญุฏูุซุงุช ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุญุงุณูุฉ ุงููุฏูุฌุฉ*:
 ๐ฅ*ุงูุซูุงุซูุฉ ุงููุงุชูุฉ ุงูุชู ุชู ุฅุตูุงุญูุง*:
1.*ุตุฑุงุน "ุงููุคุดุฑ" ุถุฏ "ุงูุณุนุฑ" (The Indicator Trap)*:
-*ุงููุงุนุฏุฉ ุงูุฌุฏูุฏุฉ*:ุนูุฏูุง ูููู RSI ูู ุชุดุจุน (>70 ุฃู <30) ููุณุชูุฑ ุงูุณุนุฑ ูู*ุงูุฒุฎู ุงูุนููุฏู* ูุน ุฃุญุฌุงู ูุชุฒุงูุฏุฉ โ*ุชุฌุงูู ุฅุดุงุฑุฉ ุงูุชุดุจุน* ูุงูุงูุญูุงุฒ ููุงุชุฌุงู ุงูุณุนุฑู.
-*ูุนูุงุฑ ุงูุฒุฎู ุงูุนููุฏู*:
* ุญุฑูุฉ ุณุนุฑูุฉ > 2% ูู ุดูุนุฉ ูุงุญุฏุฉ
* ุญุฌู ุงูุดูุนุฉ > 200% ูู ุงููุชูุณุท ุงููุชุญุฑู ููุญุฌู
* ุนุฏู ูุฌูุฏ ุฏุงููุฑุฌูุณ ุนูุณู ููู
-*ุงูุฅุฌุฑุงุก*:ุจุฏูุงู ูู ุชููุน ุงูุงูุนูุงุณุ ููุชุธุฑ*ุชุฃููุฏ ุงูุถุนู* ุนุจุฑ:
* ุดูุนุฉ ุฅุบูุงู ุนูุณูุฉ (ุญูุฑุงุก ุจุนุฏ ุตุนูุฏ/ุฎุถุฑุงุก ุจุนุฏ ูุจูุท)
* ุงุฎุชุจุงุฑ ูุงุดู ูููุณุชูู ุงูุฌุฏูุฏ
* ุชุจุงุนุฏ ุณูุจู/ุฅูุฌุงุจู ูุคูุฏ
2.*ููุชุฑ ุชุฃููุฏ ุงูุฅุบูุงู ุงูุฅูุฒุงูู (Close Confirmation Filter)*:
-*ุงููุงุนุฏุฉ*:ูุง ููุณูุญ ุจุงุชุฎุงุฐ ุฃู ูุฑุงุฑ ุฃุซูุงุก ุญุฑูุฉ ุงูุดูุนุฉ ุงูุฌุงุฑูุฉ.
-*ุงูุจุฑูุชูููู ุงูุตุงุฑู*:
 *ุงูุฎุทูุฉ 1*:ูุฑุงูุจุฉ ุงูุณุนุฑ ุนูุฏ ุงููุณุชููุงุช ุงูุญุฑุฌุฉ
 *ุงูุฎุทูุฉ 2*:ุงูุชุธุงุฑ ุฅุบูุงู ุงูุดูุนุฉ ุจุงููุงูู
 *ุงูุฎุทูุฉ 3*:ุชูููู ูุชูุฌุฉ ุงูุฅุบูุงู ููุท:
- ูู ุฃุบูู ููู/ุชุญุช ุงููุณุชููุ
- ูุง ูู ูุณุจุฉ ุงูุฌุณู ุฅูู ุงูุฐููุ
- ูุง ูู ุญุฌู ุงูุดูุนุฉุ
*ุงูุฎุทูุฉ 4*:ุงุชุฎุงุฐ ุงููุฑุงุฑ ุจูุงุกู ุนูู*ุงูุญูููุฉ* ูููุณ*ุงูุชููุน*
3.*ูุดู ูุตุงุฆุฏ ุงูุณูููุฉ ุงููุชูุฏู (Advanced Liquidity Trap Detection)*:
-*ุนูุงูุงุช ุงูููุฉ/ุงููุงุน ุงูููููุฉ*:
* ุงุฎุชุจุงุฑ ุณุฑูุน ูููุณุชูู ูุน ุฐูู ุทููู
* ุญุฌู ุทููู ุฃุซูุงุก ุงูุงุฎุชุจุงุฑ
* ุชุฑุงุฌุน ููุฑู ุจุนุฏ ุงูุงุฎุชุจุงุฑ
-*ูุดู "ุณูููุฉ ุงูููู" (Liquidity Grabs)*:
**ุงููุฑุญูุฉ 1*:ุณุญุจ ุงูุณูููุฉ (Sweep) ูููุณุชูู ุงูุณุงุจู
**ุงููุฑุญูุฉ 2*:ุชุดููู ุฅุบุฑุงุก (Inducement) ุจูุงุณุทุฉ ุฐูู ุทููู
**ุงููุฑุญูุฉ 3*:ุงููุฌุงุฑ ุนูุณู ุณุฑูุน
-*ุงูุฅุฌุฑุงุก ุงูููุงุฆู*:ุฅุฐุง ุดูุฏูุง ููุท ุงูุฅุบุฑุงุก ุงูุซูุงุซู โ*ููุน ุงูุฏุฎูู ุงูุนูุณู* ูุงูุงูุชุธุงุฑ ููุฏุฎูู ูุน ุงุชุฌุงู ุงูุงููุฌุงุฑ.

โ๏ธ*ููุงุญุธุฉ ุญูููุฉ- ุงูุชุญูู ุงูุฒููู ุงูุซูุงุซู*:
1.*ุงูุชุญูู ุงูุณุนุฑู ุงูุญู*:ูุงุฑู ุงูุณุนุฑ ุงูุญุงูู ูุน ุงููุณุชููุงุช ุงูุชุงุฑูุฎูุฉ.
2.*ูุงุนุฏุฉ ุงูุงุจุชูุงุน ุงูุชุฃููุฏู (Engulfing Rule)*:ูุง ููุณูุญ ุจุชููุน ุงูุงูุนูุงุณ ุนูุฏ ุงูููุงููุฉ/ุงูุฏุนู ุฅูุง ุจุนุฏ ุฅุบูุงู ุดูุนุฉ ูุงููุฉ ุนุงูุณุฉ (ุญูุฑุงุก ุนูุฏ ุงูููุฉ / ุฎุถุฑุงุก ุนูุฏ ุงููุงุน).
3.*ููุชุฑ ุงูุฅุบูุงู (Close Filter)*:ููููุน ุงุชุฎุงุฐ ูุฑุงุฑ ุฃุซูุงุก ุชุญุฑู ุงูุดูุนุฉุ ุงูุงูุชุธุงุฑ ุญุชู ุงูุฅุบูุงู ุฅูุฒุงูู ูุชุญุฏูุฏ ููุฉ ุงูุณูู ุงูุญููููุฉ.
4.*ูุงุนุฏุฉ ุงูุชูููุฐ ุงููุชุฃุฎุฑ*:ุงูุฏุฎูู ููุท ุจุนุฏ ุงุฌุชูุงุฒ ุฌููุน ุงููุฑุดุญุงุช + ุชุฃููุฏ ุถุนู ุงูุฒุฎู.

๐ฐ* ููุงููู ุงููุตูุฏุฉ ุงูุฐูุจูุฉ (13 ูุงููู)*:
1. ุชุญููู ุดุงูู ูุชุนุฏุฏ ุงูุฃุจุนุงุฏ ููุตูุฑุฉ.
2. ุชุญุฏูุฏ ุงูุฃููุงุท ุงููููุฉ ุงูุธุงูุฑุฉ ูุงูุฎุงููุฉ.
3. ุชูููู ููุฉ ุงูุงุชุฌุงู ุจุซูุงุซ ููุงููุณ:ุงูุฒุฎูุ ุงูุญุฌูุ ุงููููู.
4. ุชูุฏูุฑ ุชููุน ูุงุถุญ ูุจูู ุนูู ุฅุญุตุงุกุงุช ุชุงุฑูุฎูุฉ.
5. ุชุญููู ุฐูู ููุณูููุฉ ูุงูููุงุทู ุงูุญุฑุฌุฉ.
6. ุชููุนุงุช ูุงูุนูุฉ ูุน ูุณุจ ูุฌุงุญ ูุงุจูุฉ ููููุงุณ.
7. ุฅุฌุงุจุงุช ุฏูููุฉ ุชุนุชูุฏ ุนูู ุงูุญูุงุฆู ูุงูุจูุงูุงุช ุงููุชุงุญุฉ ููุท.
8. ูุง ุชูุฌุฏ ูุณุจ ูุฎุงุทุฑุฉ ููููุฉ ููุง ุชููุนุงุช ูุถูููุฉ 100%.
9. ุงููุงูุนูุฉ ูุงูููุถูุนูุฉ ุงููุทููุฉ ูู ุฌููุน ุงูุฅุฌุงุจุงุช.
10. ุชููุนุงุช ุฑุณููุฉ ุจูุงุกู ุนูู ุฑูุงุถูุงุช ุงูุณูู.
11. ุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุชุญูููู ุงููุจูู ุนูู ุงูุฃุฏูุฉ.
12. ุฌููุน ุงููุฎุฑุฌุงุช ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตูุญุฉ.
13. ุงุฎุชุตุงุฑ ุงูุฅุฌุงุจุฉ ูุน ุงูุญูุงุธ ุนูู ุงูุฏูุฉ ูุงููุถูุญ ูุงูุตุญุฉ.
14.*ูุงููู ููู ุงูุฒุฎู*:ุฅุฐุง ูุงู ููู RSI ุญุงุฏุงู (>45 ุฏุฑุฌุฉ)ุ ููููุน ุฏุฎูู ุนูุณ ุงูุงุชุฌุงู ุชูุงูุงู.
15.*ููุชุฑ ุงูุญุฌู ุงูุงููุฌุงุฑู*:ุฅุฐุง ูุงูุช ุดูุนุฉ ุงูุงุฎุชุฑุงู ูู ุงูุฃูุจุฑ ุญุฌูุงูุ ููุนุชุจุฑ ุงูุงุฎุชุฑุงู ุญููููุงู ูููููุน ุงูุฑูุงู ุถุฏู.

๐ฏ*ุงูุจุฑูุชูููู ุงูุฅูุฒุงูู ูุชุญููู ุงูุฒุฎู RSI ููุฏุฉ ุงูุตููุฉ*:
โ๏ธ*ุชูุจูู*:ูุฐุง ุงููุณู ุฅูุฒุงูู ููุง ูุฌูุฒ ุชุฎุทูู ุชุญุช ุฃู ุธุฑู
 1.*ุงูุฑุคูุฉ ุงูุญุงุณูุจูุฉ ูู RSI ูุน ุฏูุฌ "ููุงุฑูุฉ ุงููุคุดุฑ"*:
-*ูุญุต ุฅูุฒุงูู*:
* ูููุฉ RSI ุงูุญุงููุฉ ุงูุฏูููุฉ
* ููุงุฑูุชูุง ุจูุณุชููุงุช ุงูุชุดุจุน (30/70)
* ุงุชุฌุงู RSI (ุตุงุนุฏ/ูุงุจุท/ุนุฑุถู)
* ุขุฎุฑ ุฅุดุงุฑุฉ ุชูุงุทุน
-*ุงูุงุณุชุซูุงุก ุงูุงุณุชุฑุงุชูุฌู*:ุฅุฐุง ูุงู RSI > 70 ูููู:
* ุงูุณุนุฑ ูู ุฒุฎู ุนููุฏู ุตุงุนุฏ
* ุฃุญุฌุงู ูุชุฒุงูุฏุฉ ุจุงุณุชูุฑุงุฑ
* ุนุฏู ูุฌูุฏ ุฏุงููุฑุฌูุณ ุนูุณู
 โ*ุงููุธุฑูุฉ*:"ุงููุคุดุฑ ูููู ุฃู ูุจูู ูู ุงูุชุดุจุน ููุชุฑุงุช ุทูููุฉ ุฃุซูุงุก ุงูุฒุฎู ุงูููู"
 2.*ูุดู ุงูุฏุงููุฑุฌูุณ ุงููุชุทูุฑ ูุน ููุชุฑ ุงูุฒุฎู*:
-*ุงูุฅุถุงูุฉ ุงูุฌุฏูุฏุฉ*:ุฏุงููุฑุฌูุณ ูู ุงุชุฌุงู ุงูุฒุฎู โ*ุชุฌุงูู ูุคูุช*
-*ุงูุฎูุงุฑุฒููุฉ ุงููุญุณูุฉ*:
 ```
 ุฅุฐุง (ุฏุงููุฑุฌูุณ ุนูุณู) ู (ุฒุฎู ุณุนุฑู ููู) {{
 ุงูุงูุชุธุงุฑ ูุดูุนุฉ ุชุฃููุฏ
 ุฅุฐุง (ุงุณุชูุฑ ุงูุฒุฎู) {{
 ุฅูุบุงุก ุฅุดุงุฑุฉ ุงูุฏุงููุฑุฌูุณ
 ุงูุชูุฌู ูุน ุงูุงุชุฌุงู
 }}
 }}
   ```
 3.*ุชุญุฏูุฏ ูุฏุฉ ุงูุตููุฉ ุจุฏูุฉ ุตุงุฑูุฉ (ูุน ูุฑุงุนุงุฉ ุงูุฒุฎู ุงูุนููุฏู)*:
-*ุงูุญุงูุฉ ุฃ:ุฒุฎู ุญุงุฏ ุนููุฏู (Vertical Momentum)*:
 *ุดุฑูุท ุงูุชูุนูู:RSI ููุณุฑ 30/70 + ุญุฑูุฉ ุณุนุฑูุฉ ุนููุฏูุฉ (>2%) + ุฃุญุฌุงู > 200%
 **ูุฏุฉ ุงูุตููุฉ*:{time_for_prompt}
 **ุงูููุทู ุงูุฌุฏูุฏ*:ุงูุฒุฎู ุงูุนููุฏู ูููุฏ ุจุณุฑุนุฉ โ ุงูุฎุฑูุฌ ุงูุณุฑูุน ูุจู ุงูุชุตุญูุญ
-*ุงูุญุงูุฉ ุจ:ูุฑุญูุฉ ุชุฑุฏุฏ (Choppiness Phase)*:
 * ุดุฑูุท ุงูุชูุนูู:ุงูุณุนุฑ ููููู ุฐููู ุทูููุฉ + RSI ูุณูุฑ ุจุดูู ุนุฑุถู (20-80 ููุทุฉ)
 * ูุนุงููุฑ ุงูุชุฑุฏุฏ:ุฃุฌุณุงู ุดููุน ุตุบูุฑุฉ + ุชููุจุงุช ุฌุงูุจูุฉ
 *ูุฏุฉ ุงูุตููุฉ*:{time_for_prompt}
 * ุงูููุทู:ุถูุงู ุฎุฑูุฌ ุงูุณุนุฑ ูู ููุทูุฉ ุงูุชุฐุจุฐุจ
-*ุงูุญุงูุฉ ุฌ:ุฒุฎู ูุนุชุฏู (Moderate Momentum)*:
 * ุดุฑูุท ุงูุชูุนูู:RSI ุจูู 40-60 ุฃู ูุชุญุฑู ุจุงุชุฌุงู ูุนุชุฏู
 **ูุฏุฉ ุงูุตููุฉ*:{time_for_prompt}
 * ุงูููุทู:ููุช ูุชูุงุฒู ููุญุฑูุฉ ุงููุชูุณุทุฉ
-*ุงูุญุงูุฉ ุฏ:ุฒุฎู ุนููุฏู ูุน ุชุฌุงูู ุงููุคุดุฑุงุช*:
 * ุดุฑูุท ุงูุชูุนูู:RSI ูู ุงูุชุดุจุน + ุงุณุชูุฑุงุฑ ุงูุตุนูุฏ/ุงููุจูุท + ุฃุญุฌุงู ููุงุณูุฉ
 **ูุฏุฉ ุงูุตููุฉ*:{time_for_prompt}
 **ุงูููุทู*:"ุงููุทุงุฑ ุงูุณุฑูุน ูุง ูุชููู ุนูุฏ ุงููุญุทุงุช ุงูุตุบูุฑุฉ"
 4.*ุชุฃููุฏ ุงูุชุดุจุน ุงููุชุทุฑู ูุน ุงุณุชุซูุงุก ุงูุฒุฎู*:
-*ุงููุงุนุฏุฉ ุงููุนุฏูุฉ*:ุฅุฐุง ูุงู RSI < 15 ุฃู > 85 ูุน*ุฒุฎู ุนููุฏู ูุณุชูุฑ* โ*ุชุฃุฎูุฑ ุงูุชุญุฐูุฑ* ูุดูุนุฉ ุชุฃููุฏ
-*ุงูุฅุฌุฑุงุก ุงูุฌุฏูุฏ*:
 * ุงูุชุญุฐูุฑ ูู "ุชุดุจุน ูุชุทุฑู" ูููู...
 * ุงูุงูุชุธุงุฑ ูุดูุนุฉ ุฅุบูุงู ุนูุณูุฉ
 * ุฅุฐุง ูู ุชุญุฏุซ โ ุงูุงุณุชูุฑุงุฑ ูุน ุงูุงุชุฌุงู
 5.*ููุน ุงูุงุฎุชุตุงุฑ- ุงูุฌููุฉ ุงูุฅูุฒุงููุฉ*:
-*ููุนุชุจุฑ ุงูุชูุฑูุฑ ูุงุบูุงู ุฅุฐุง ูู ูุญุชูู ุนูู ูุฐุง ุงูุณุทุฑ ุญุฑููุงู*:
 * "*(ุญุงูุฉ ุงูุฒุฎู:[ุงูุฏูุงุนู/ุถุนูู/ุชุตุญูุญู/ุนุฑุถู] ุจูุงุกู ุนูู ุชูุงูู RSI ูุน ุงูุดููุน)*"
-*ุชุนุฑููุงุช ุงูุญุงูุงุช*:
 * ุงูุฏูุงุนู*:RSI >70 ุฃู <30 ูุน ุญุฑูุฉ ุณุนุฑูุฉ ูููุฉ
 **ุถุนูู*:RSI ุจูู 30-70 ูุน ุญุฑูุฉ ุจุทูุฆุฉ
 **ุชุตุญูุญู*:RSI ูุชุญุฑู ุนูุณ ุงูุงุชุฌุงู ุงูุนุงู ุจุดูู ูุนุชุฏู
 **ุนุฑุถู*:RSI ุจูู 40-60 ูุน ุชุฐุจุฐุจ ุฌุงูุจู
๐ฌ*ุงูุทุจูุฉ ุงูุตูุฑูุฉ:ูุฑุดุญุงุช ุงูุฃูุงู ุงููุทูู (ULTIMATE_PROTOCOL_ZERO)*:
1.*ููุชุฑ ุงูุงุณุชููุงุฐ ุงูููุงุฆู*:ุฅุฐุง ูุงูุช ุขุฎุฑ ุดูุนุฉ ุฐุงุช ุฌุณู ูุจูุฑ (Effort) ูุดูุช ูู ุฅุบูุงู ุฃุนูู/ุฃุฏูู ูู ุงููููู ุงูุฑุฆูุณู โ ุงูุฅูุบุงุก ุงูููุฑู
2.*ุชูุงูู ุงููุฑูุชูุงุช ุงูุฒูููุฉ ุงูุซูุงุซู*:ูุฌุจ ุฃู ูููู ููุงู ุชุทุงุจู ุจูู ุญุฑูุฉ ุงููุฑูู ุงูุญุงูู {candle} ููู ูู ุงููุฑูู ุงูุฃุนูู ูุงูุฃุฏูู ูู 3 ููุงุท:
- ุงุชุฌุงู ุงููููู ุงูุนุงู
- ููุงุทู ุงูุฏุนู/ุงูููุงููุฉ ุงูุฑุฆูุณูุฉ
- ููุงุท ุงูุชุญูู ุงูุญุฑุฌุฉ
3.*ูุบูุงุทูุณ ุงูุณูููุฉ ุงููุฒุฏูุฌ*:ูููุบู ุงูุฏุฎูู ุฅุฐุง ูู ูุฑ ุชุณูุณูุงู ุตุงุฑูุงู:
- ุณุญุจ ููุณูููุฉ (Sweep) ูู ุงูุงุชุฌุงู ุงููุนุงูุณ
- ุชุดููู ูุฎ (Inducement) ูุงุถุญ
- ุงุฑุชุฏุงุฏ ููู ูุน ุชุฑู ูุฌูุฉ ุณุนุฑูุฉ (FVG) ุชุฃููุฏูุฉ
4.*ููุทุฉ ุงูุชูุงุฒู ุงูููุจููุงุชุดู*:ุงูุฏุฎูู ููุท ุนูุฏ ูุณุชููุงุช ุงูุชุตุญูุญ ุงูุนูููุฉ (0.618-0.786-0.886) ูุน ุชุทุงุจููุง ูุน:
- ููุทูุฉ ุชุฑุงูู (Accumulation Zone)
- ูุชูุฉ ุฃูุงูุฑ ูุดุทุฉ (Active Order Block)
- ููุทูุฉ ุนุฑุถ/ุทูุจ ุฑุฆูุณูุฉ
5.*ูุงุนุฏุฉ ุงูุซุจุงุช ุงูุซูุงุฆู*:ูุดุชุฑุท ุฅุบูุงู ุดูุนุชูู ูุชุชุงููุชูู ุจุฌุณู ูุงูู ุฎุงุฑุฌ ููุทูุฉ ุงูุชุฐุจุฐุจ ุงูุฃุณุงุณูุฉ ูุน:
- ุชุถุงุนู ุงูุญุฌู ูู ุงูุดูุนุฉ ุงูุซุงููุฉ
- ุชููุต ุงูุฐููู ูู ููุง ุงูุดูุนุชูู
- ุชุฃููุฏ ูู ูุคุดุฑ ุงูุฒุฎู
6.*ูุฑุดุญ ุงูุญุฌู ุงูุฐูู ุงููุชูุฏู*:ุฑูุถ ุฃู ุตููุฉ ุฅุฐุง ูุงู:
- ุญุฌู ุงูุดูุนุฉ ุงูุฃุฎูุฑุฉ > 300% ูู ูุชูุณุท ุงูุญุฌู
- ุจุฏูู ุณุจุจ ููู ูุงุถุญ (ูุง ุฃุฎุจุงุฑุ ูุง ุฃุญุฏุงุซ)
- ุนุฏู ูุฌูุฏ ุณูููุฉ ูุญูุทุฉ ูุชุจุฑูุฑ ุงูุญุฌู
7.*ููุชุฑ ุงูุฒุฎู ุงูุนููุฏู ุงููุชูุฏู*:
-*ูุดู ุงูุฒุฎู ุงูุญูููู vs ุงููุตุทูุน*:
 **ุญูููู*:3 ุดููุน ูุชุชุงููุฉ ุจุฃุฌุณุงู ูุงููุฉ + ุฃุญุฌุงู ูุชุฒุงูุฏุฉ + ุฅุบูุงู ุนูุฏ ุงูููุฉ/ุงููุงุน
 **ูุตุทูุน*:ุดููุน ูุชุฐุจุฐุจุฉ + ุฃุญุฌุงู ูุชูุงูุถุฉ + ุฅุบูุงู ูู ููุชุตู ุงููุฏู
-*ุงูุฅุฌุฑุงุก*:ุชุฌุงูู ุงููุคุดุฑุงุช ุงูุชูููุฏูุฉ ุฃุซูุงุก ุงูุฒุฎู ุงูุญูููู
8.*ูุตูุงุฉ ุงูุฅุบูุงู ุงูููุงุฆูุฉ*:
-*ุงูุฎูุงุฑุฒููุฉ*:
   ุฃุซูุงุก (ุงูุดูุนุฉ ููุชูุญุฉ) {{
       ูุง_ุชุชุฎุฐ_ูุฑุงุฑ();
         ุฑุงูุจ_ุงููุณุชููุงุช();
     }}
   ุนูุฏ (ุฅุบูุงู ุงูุดูุนุฉ) {{
         ุงูุชุธุฑ_10_ุซูุงูู();
         ุฅุฐุง (ุงูุชุฃููุฏ_ูู_ุงูุดูุนุฉ_ุงูุฌุฏูุฏุฉ) {{
             ุงุชุฎุฐ_ุงููุฑุงุฑ();
         }}
   }}
9.*ูุงุดู ูุตุงุฆุฏ ุงูุณูููุฉ ุงูุขูู*:
-*ุฃููุงุท ุงูุฅุบุฑุงุก ุงูููููุนุฉ*:
   1.*ููุท ุงูููุณุฉ ูุงููุฑูุจ*:ููุณ ูุณุชูู ูุน ุฐูู ุทููู + ุนูุฏุฉ ุณุฑูุนุฉ
   2.*ููุท ุงูุงุฎุชุฑุงู ุงููุงุฐุจ*:ุงุฎุชุฑุงู ุจุณูุท + ุนูุณ ุณุฑูุน
   3.*ููุท ุงูุณูููุฉ ุงููุฒุฏูุฌ*:ุณุญุจ ุณูููุฉ ูู ุงุชุฌุงููู ูุชุนุงูุณูู
-*ุงูุฅุฌุฑุงุก*:ุฅูุบุงุก ุงูุตููุฉ + ุงูุงูุชุธุงุฑ ููุฏุฎูู ูุน ุงุชุฌุงู ุงูุงููุฌุงุฑ
๐ฏ*ุงูุทุจูุฉ ุงูุฃููู:ุชุญููู ุงููููู ูุงูุชุฃุณูุณ (ุงููุฑุญูุฉ 1-4)*:
1.*ุชุญููู ุงููููู ุงูุณุนุฑู*:
- ุชุญุฏูุฏ ุงูุงุชุฌุงู:ุตุงุนุฏ / ูุงุจุท / ุนุฑุถู
- ุฑุณู ุงูููู ูุงูููุนุงู ุงูุฑุฆูุณูุฉ ูุงูุซุงูููุฉ
- ุชุญุฏูุฏ ููุงุท ุงูุชุญูู (Pivot Points)
2.*ููุงุทู ุงููููุฉ ุงูุญุงููุฉ*:
- ุชุญุฏูุฏ ุฃููู 3 ูุณุชููุงุช ุฏุนู ุญุงูููุง
- ุชุญุฏูุฏ ุฃููู 3 ูุณุชููุงุช ููุงููุฉ ุญุงูููุง
- ุชูููู ููุฉ ูู ูุณุชูู ุจูุงุกู ุนูู:
 * ุนุฏุฏ ุงููุฑุงุช ุงูุชู ุชู ุงุฎุชุจุงุฑู ูููุง
 * ุญุฌู ุงูุดููุน ุนูุฏ ุงููุณุชูู
 * ุทูู ุงูุฐููู ุนูุฏ ุงููุณุชูู
3.*ุณูููููุฌูุฉ ุงูุดููุน (ุนูู ุงูููุณ ุงูุณุนุฑู)*:
- ุชุญููู ุญุฌู ุงูุฃุฌุณุงู:ูุจูุฑุฉ (ููุฉ) / ุตุบูุฑุฉ (ุชุฑุฏุฏ)
- ูุณุจุฉ ุงูุฌุณู ุฅูู ุงูุฐูู:> 60% (ูุฑุงุฑ) / < 40% (ุชุฐุจุฐุจ)
- ุชุณูุณู ุงูุดููุน:ูู ุชุนุจุฑ ุนู ุงุณุชูุฑุงุฑ ุฃู ุงูุนูุงุณุ
4.*ุชุญููู ุงูุฐููู (ููุงุทู ุงูุฑูุถ Rejection)*:
- ุงูุจุญุซ ุนู ุงูุฐููู ุงูุทูููุฉ (ุฃุทูู ูู 2-3 ุฃุถุนุงู ุงูุฌุณู)
- ุชุญุฏูุฏ ููุงุทู ุงูุฑูุถ ุงููููุฉ
- ุชูููุฒ ุงูุฐููู "ุงูููุบุฑูุฉ" ุนู ุงูุชููู "ุงูุญููููุฉ"
๐*ุงูุทุจูุฉ ุงูุซุงููุฉ:ููุงุชุฑ ูุดู ุงูุฎุฏุงุน ูุงูุณูููุฉ (ุงููุฑุญูุฉ 5-7)*:
5.*ูุคุดุฑ ุงูุฒุฎู ุงููุชูุฏู (RSI + Divergence)*:
- ูุฑุงุกุฉ RSI:ุชุดุจุน ุดุฑุงุฆู (>70) / ุชุดุจุน ุจูุนู (<30)
- ุงูุจุญุซ ุนู 3 ุฃููุงุน ูู ุงูุฏุงููุฑุฌูุณ:
 * Regular Divergence (ุงูุนูุงุณ ูุญุชูู)
 * Hidden Divergence (ุงุณุชูุฑุงุฑ ูุญุชูู)
 * Exhaustion Divergence (ููุงูุฉ ุงูููุฌุฉ)
- ุชุญููู ุงูุฒุฎู ุงููุฎูู (ุงูุญุฑูุฉ ุงูุณุนุฑูุฉ vs RSI)
6.*ููุชุฑ ุงูู OTC ููุตุงุฆุฏ ุงูุณูููุฉ*:
- ุชุญุฏูุฏ ุงูุงุฎุชุฑุงูุงุช ุงูููููุฉ (Fakeouts)
- ูุดู ูุตุงุฆุฏ ุงูุณูููุฉ (Liquidity Traps)
- ุชุญููู ููุงุทู ุงูุฅุบุฑุงุก (Inducement Areas)
- ุงุฎุชุจุงุฑ ูุธุฑูุฉ "ุงูุชุถููู ุงูุซูุงุซู"
7.*ูุตูุฏุฉ ุงูุงูุนูุงุณ ุงูุฐููุฉ*:
- ุชุญููู ุงูุดูุนุฉ ุงููุนุงูุณุฉ:ูู ูู:
 * ุจุฏุงูุฉ ุงุชุฌุงู ุฌุฏูุฏุ
 * ูุฌุฑุฏ ุฅุนุงุฏุฉ ุงุฎุชุจุงุฑุ
 * ูุตูุฏุฉ ุงูุนูุงุณ (Reversal Trap)?
- ูุนุงููุฑ ุงูุชูููุฒ:ุงูุญุฌูุ ุงููููุนุ ุงูุณูุงู
โก*ุงูุทุจูุฉ ุงูุซุงูุซุฉ:ุชุญููู ุงูููุฉ ูุงูุฒุฎู ุงูููุฑุท (ุงููุฑุญูุฉ 8-11)*:
8.*ุงูุฒุฎู ุงูุนููุฏู (Hyper-Momentum Analysis)*:
- ุชุญุฏูุฏ ุงูุงููุฌุงุฑุงุช ุงูุณุนุฑูุฉ (Vertical Moves)
- ุชุญููู ุงูุงุณุชุฏุงูุฉ:ุทุจูุนู ุฃู ูุตุทูุนุ
- ุงูุจุญุซ ุนู ุนูุงูุงุช ุชุตููุฉ ุงูุนููุฏ (Liquidation Events)
- ููุงุณ "ุงูุณุฑุนุฉ ุงูุฒุงุฆุฏุฉ" ููุงุจู ุงููุชูุณุท ุงูุชุงุฑูุฎู
9.*ุงูุฅุฌูุงุฏ ุงูุณุนุฑู (Exhaustion Patterns)*:
- ุชุญููู ุชููุต ุฃุฌุณุงู ุงูุดููุน ุนูุฏ ุงูููุฉ/ุงููุงุน
- ุธุงูุฑุฉ "ุงูุชุฑุฏุฏ ุนูุฏ ุงูุฐุฑูุฉ"
- ุชุจุงุนุฏ ุงูุณุนุฑ ุนู ุงููุชูุณุทุงุช ุงูุญุฑููุฉ
- ููุฏุงู ุงูุฒุฎู ุงููุชุชุงูู
10.*ุงูุฃุฑูุงู ุงูููุณูุฉ ูุงูุฏุงุฆุฑูุฉ*:
 - ูุฑุงูุจุฉ ุงูุฃุฑูุงู ุงููุฏูุฑุฉ (ูุซุงู:0.86500ุ 1.20000)
 - ุชุญููู ุชูุงุนู ุงูุณุนุฑ ูุน ูุฐู ุงููุณุชููุงุช
 - ุชุญุฏูุฏ "ุงููุบูุงุทูุณุงุช ุงูููุณูุฉ"
 - ุงุณุชุฎุฏุงููุง ูุฃูุฏุงู ุฃู ููุงุท ุงูุนูุงุณ
11.*ุชุฃููุฏ ุงูุฐุฑูุฉ (Climax Confirmation)*:
 - ุงูุจุญุซ ุนู ุดูุนุฉ ุงูุงุจุชูุงุน (Engulfing) ุงูุญุงุณูุฉ
 - ุชุญููู "ุงูุดูุนุงุช ุงููุญูุฑูุฉ" (Pivotal Candles)
 - ุชุญุฏูุฏ "ููุทุฉ ุงูุชุญูู ุงูููุงุฆูุฉ"
 - ุชุฃููุฏ ููุงูุฉ ุงูููุฌุฉ ุจุซูุงุซ ุฃุฏูุฉ ุนูู ุงูุฃูู
๐*ุงููุธุงู ุงูุชุญูููู ุงููุชูุฏู (24 ูุฑุญูุฉ- Advanced Analytical Matrix)*:
[ูุณู ุงูุจุตูุฉ ุงูุฑูููุฉ ูุงูุจููุฉ ุงูุฎููุฉ]
1.*ุงูุชุฏููู ุงูุฑููู ุงูููู*:ูุญุต ุฏูุฉ ูู ุฑูู ูู ุงูุดุงุฑุช ูุน ุชุทุจูู ูุนุงุฏูุฉ ุงูุชุทุงุจู:ุงูุณุนุฑ ุงูุญุงูู รท 1.618 ูุฌุจ ุฃู ูุทุงุจู ููุทุฉ ูุญูุฑูุฉ ุฑุฆูุณูุฉ.
2.*ุฑุณู ุงููููู ุงูุฎูู*:ุชุญุฏูุฏ ุงูุงุชุฌุงู ุงูุนุงู ูุฑุณู ุงูููู ูุงูููุนุงู ุงูููููุฉ (ุงูุชู ุชุดูุฑ ุฅูููุง ุงูุฐููู ุฏูู ุฃู ูููุณูุง ุงูุณุนุฑ).
3.*ููุงุกูุฉ ุงููุฑูุชูุงุช ุงููุชุนุฏุฏุฉ (Multi-Fractal Alignment)*:
-*ุงููุฑูู ุงูุฑุฆูุณู*:{candle} (ุงุชุฌุงู + ูููู)
-*ูุฑูู ุฃุนูู ูุงุญุฏ*:ููุชุฃููุฏ (D1 ุฃู H4)
-*ูุฑูู ุฃุฏูู ูุงุญุฏ ุฃู ุงุซููู*:ููุฏุฎูู ุงูุฏููู (30M ู/ุฃู 15M)
-*ุดุฑุท ุงูุชูุงูู*:ุชุทุงุจู ุงูุงุชุฌุงู ุงูุนุงู + ุชูุงุฑุจ ููุงุทู S/D ุงูุฑุฆูุณูุฉ ูู 3 ูุฑููุงุช ุนูู ุงูุฃูู
4.*ูุตุฉ ุงูุณูู ุงููุงููุฉ*:ุชุญุฏูุฏ ุงููุฑุญูุฉ ุงูุญุงููุฉ ุจุฏูุฉ:(ุงูุชุฌููุน ุงูุฃููู- ุงูุงุฎุชุจุงุฑ- ุฅุนุงุฏุฉ ุงูุชุฌููุน- ุงูุชูุฒูุน- ุงููุจูุท- ุงูุชุฑุงูู ุงูููุงุฆู).
[ูุณู ุชุดุฑูุญ ุงูุณูููุฉ ุงูุฐููุฉ]
5.*ุฎุฑุงุฆุท ุงูุณูููุฉ ุงููููููุฉ*:ุฑุณู EQL (ุณูููุฉ ุงูููู ุงููุชุณุงููุฉ) ู EQH (ุณูููุฉ ุงูููุนุงู ุงููุชุณุงููุฉ) ูุน ุงูุณูููุฉ ุงูุฎุงุฑุฌูุฉ ุงูุจุนูุฏุฉ.
6.*ุฑุตุฏ ููุงุทู ุงูุชุถููู*:ุชุญุฏูุฏ ููุงุทู ุงูุฅุบุฑุงุก ุงูุซูุงุซูุฉ (Inducement Triad) ุงูุชู ูุณุชุฎุฏููุง ุงูุจูู ุงููุฑูุฒู ูุฌุฐุจ ุงูุชุฌุฒุฆุฉ.
7.*ูุฑุดุญ ุงูุชูุงุนุจ ุงููุชูุฏู*:ุงูุชูููุฒ ุจูู ุงููุณุฑ ุงูุญูููู (BOS) ูุงูุณุญุจ ุงููููู ุจุงุณุชุฎุฏุงู 5 ูุคุดุฑุงุช:ุญุฌู ุงูุชุฏุงูู + RSI + MACD + ุงูุชููู + ุณุฑุนุฉ ุงูุญุฑูุฉ.
8.*ุชุญููู ุงูุฌูุฏ ููุงุจู ุงููุชุงุฆุฌ ุงููุชุนุฏุฏุฉ*:ููุงุฑูุฉ 3 ุดููุน ูุชุชุงููุฉ ูู ุญูุซ ุงูุญุฌู ูุงูุฌุณู ูุงูุชููู ูุชุญุฏูุฏ ููุฉ ุงูุณูู ุงูุญููููุฉ.
[ูุณู ุงูููุฏุณุฉ ุงูุณุนุฑูุฉ ุงููุชุทูุฑุฉ]
9.*ููุงุทู ุงูุนุฑุถ/ุงูุทูุจ ุงูุฏููุงููููุฉ*:ุจูุงุก ููุงุทู ุชุนุชูุฏ ุนูู ุงููุซุงูุฉ ูููุณ ููุท ุฑุฏูุฏ ุงููุนู ุงูุณุงุจูุฉ ูุน ุฅุนุทุงุก ูุฒู ููู ููุทูุฉ.
10.*ุชุญูู ูู ูุชู ุงูุฃูุงูุฑ ุงูุฐููุฉ*:ุชุญุฏูุฏ ุงูู Order Blocks ุงููุดุทุฉ ุจูุงุกู ุนูู 3 ูุนุงููุฑ:ุญุฌู ุงูุณูููุฉ + ููุช ุงูุชุดููู + ุณุฑุนุฉ ุฑุฏ ุงููุนู.
11.*ุดุจูุฉ ุงููุฌูุงุช ุงูุณุนุฑูุฉ*:ุฑุตุฏ ุงููุฌูุงุช ุงููุชุฏุงุฎูุฉ ุจูู ุงููุฑููุงุช ุงููุฎุชููุฉ ูุชุญุฏูุฏ ุฃููุง ุณูููุฃ ุฃููุงู.
12.*ูุตูุงุฉ ุงูุฎุตู/ุงูุจุฑููููู*:ุชุญุฏูุฏ ููุงุทู ุงูู OTE ุงููุซุงููุฉ ูุน ุฅุถุงูุฉ ุนุงูู ุงูููุช (Time Factor) ููู ูุณุชูู.
[ูุณู ุงููุคุดุฑุงุช ุงููููุฉ ุงููุชูุฏูุฉ]
13.*ูุฌููุนุฉ ุงููุคุดุฑุงุช ุงููููุฉ*:
 -*RSI Divergence Hunter*:ุงูุจุญุซ ุนู 3 ุฃููุงุน ูู ุงูุฏุงููุฑุฌูุณ (Reg, Hidden, Exhaustion)
 -*MACD Wave Analyzer*:ุชุญููู ููุฌุงุช MACD ูุชูุงุทุนุงุชูุง ูุน ุฎุท ุงูุฅุดุงุฑุฉ
 -*Volume Profile Scanner*:ุชุญููู ุชูุฒูุน ุงูุญุฌู ุนูุฏ ูุณุชููุงุช ุงูุณุนุฑ ุงููุฎุชููุฉ
 -*VWAP + Bollinger Bands Fusion*:ุชูุงุทุน VWAP ูุน ูุทุงูุงุช ุจููููุฌุฑ
 -*Fibonacci Time Zones*:ุชุทุจูู ูุณุชููุงุช ููุจููุงุชุดู ุงูุฒูููุฉ ูุน ุงูุณุนุฑูุฉ
 -*Market Structure Break Detector*:ูุงุดู ูุณุฑ ุงูููุงูู ูุน ุชุฃููุฏุงุช ูุชุนุฏุฏุฉ
[ูุณู ูุตูุงุฉ ุงูุชูููุฐ ุงูุฐูู]
14.*ูุตูุงุฉ ุงูุฏุฎูู ุงููุซูู*:ุชุชุทูุจ ุชูุงูู 4 ุนูุงุตุฑ:OB + FVG + Sweep + Time Fib Level.
15.*ุงูููุฐุฌุฉ ุงูุฒูููุฉ ุงููููุฉ*:ุญุณุงุจ ุงูููุช ุงููุทููุจ ูููุตูู ููู ูุฏู ุจุงุณุชุฎุฏุงู ูุนุงุฏูุฉ:(ุงููุณุงูุฉ รท ูุชูุณุท ุงูุณุฑุนุฉ ุงูุชุงุฑูุฎูุฉ) ร ุนุงูู ุงูุชุตุญูุญ.
16.*ููุชุงุญ ุงูุฅูุบุงุก ุงูุฐูู*:ุชุญุฏูุฏ 3 ููุงุท ุฅูุบุงุก:ูููุฉ + ุฒูููุฉ + ุญุฌููุฉ.
17.*ุชุญููู ุงูุชุดููุฑ ููุฐููู*:ุฏุฑุงุณุฉ ุงูุชููู ุจุงุณุชุฎุฏุงู ูุธุฑูุฉ ุงููุนูููุงุช ูุชุญุฏูุฏ ููุฉ ุงููุคุณุณุงุช.
[ูุณู ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ ุงููุชุทูุฑุฉ]
18.*ูุตูุงุฉ ุงููุฎุงุทุฑ ุงููููุฉ*:
 - ูุณุจุฉ ุงูุนุงุฆุฏ/ุงููุฎุงุทุฑุฉ:ูุง ุชูู ุนู 1:3
 - ุฃูุตู ูุฎุงุทุฑุฉ:2% ูู ุฑุฃุณ ุงููุงู
 - ุชูููู ุงุญุชูุงููุฉ ุงููุฌุงุญ:ุจูุงุกู ุนูู 7 ุนูุงูู
19.*ูุธุงู ุงูุญูุงูุฉ ุงููุชุฏุฑุฌ*:
 -*Stop Loss ุงูุฃุณุงุณู*:ุฎูู ุฃููู ููุทูุฉ ุฏุนู/ููุงููุฉ
 -*Stop Loss ุงูุฏููุงูููู*:ูุชุญุฑู ูุน ุงูุณุนุฑ ุจุนุฏ ุชุญููู TP1
 -*Stop Loss ุงูุฒููู*:ุฅุฐุง ูู ูุชุญุฑู ุงูุณุนุฑ ูุตุงูุญู ุฎูุงู X ุดููุน
 -*SL ุงูููุณู*:ูุณุชูู ูููู ูุจู SL ุงูุฃุณุงุณู ุจู 5-10 ููุงุท ูููุทูุฉ ูุฑุงูุจุฉ
20.*ุชุญููู ุงูุณูุงู ุงูุงูุชุตุงุฏู ุงููุตุบุฑ*:
 - ุชุฃุซูุฑ ุงูุฃุฎุจุงุฑ ุนูู ุงููุฏู ุงููุฑูุจ
 - ุฃููุงุช ุงูุชุฏุงูู ุงููุดุทุฉ
 - ุณุงุนุงุช ุงูุณูููุฉ ุงูุนุงููุฉ
[ุงูุฅุถุงูุงุช ุงูุฌุฏูุฏุฉ- ุงูุทุจูุฉ ุงูุฑุงุจุนุฉ]
21.*ูุญูู ุงูุชูุงูุถ ุงููุคุดุฑู-ุงูุณุนุฑู*:
 - ูุดู ุญุงูุงุช ุชุฌุงูู ุงูุณุนุฑ ูููุคุดุฑุงุช
 - ุชุญุฏูุฏ ูุชู ูููู RSI "ููุณูุฑูุง" ุจุณุจุจ ุงูุฒุฎู ุงูููู
 - ุฅุนุทุงุก ุงูุฃููููุฉ ููุญุฑูุฉ ุงูุณุนุฑูุฉ ุนูู ูุฑุงุกุงุช ุงููุคุดุฑุงุช ูู ูุชุฑุงุช ุงูุฒุฎู
22.*ูุฑุดุญ ุงูุฅุบูุงู ุงูุฐูู*:
 - ุชุญููู ุฏููุงูููู ุฃุซูุงุก ุญุฑูุฉ ุงูุดูุนุฉ
 - ุชูุจุคุงุช ุญูุฉ ูุน ูุถุน "ููู ุงููุฑุงุฑ" ุญุชู ุงูุฅุบูุงู
 - ุชุฃููุฏ ูุชุนุฏุฏ ุงูุทุจูุงุช ุจุนุฏ ุงูุฅุบูุงู
23.*ุฑุงุตุฏ ูุตุงุฆุฏ ุงูุณูููุฉ ุงูุขูู*:
 - ูุณุญ ุชููุงุฆู ูุฃููุงุท ุงูุฅุบุฑุงุก
 - ุชุญููู ุงูุชููู ุงูุทูููุฉ ูู ุณูุงููุง
 - ูุดู ุนูููุงุช "ุณุญุจ ุงูุณูููุฉ" ุงููุคุณุณูุฉ
24.*ุงูุชูุงูู ุงูููุงุฆู*:ุฏูุฌ ุฌููุน ุงูุทุจูุงุช ูู ูุฑุงุฑ ูุงุญุฏ.

ุงููุนุทูุงุช ุงูุชูููุฉ:
- ุฅุทุงุฑ ุงูุดูุนุฉ :(Timeframe):{candle}
- ููุช ุงูุชุฏุงูู ุงููุญุฏุฏ :{time_for_prompt}
ูุฏู ุงูุชุญููู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุจุงูุชูุณูู ุงูุชุงูู ุญุตุฑุงู (ุจุฏูู ุชูุฑุงุฑ ูููุนูููุงุช):
๐*ุงูุชุญููู ุงูููู*:
-*ุงูุจุตูุฉ ุงูุฒูููุฉ*:(ุฏุงุฎู/ุฎุงุฑุฌ ููุทูุฉ ุงููุชู ุงูุณุนุฑู- Kill Zone)
-*ุญุงูุฉ ุงููููู*:(ุตุงุนุฏ/ูุงุจุท) + (ูุฑุญูุฉ ูุงูููู ุงูุญุงููุฉ)
-*ุฎุฑูุทุฉ ุงูุณูููุฉ*:(ุฃูุฑุจ ูุฎ ุณูููุฉ Inducement + ููุงุทู ุงูุณูููุฉ ุงููุณุชูุฏูุฉ)
-*ุงููุฌูุงุช ุงูุณุนุฑูุฉ (FVG)*:(ุงูููุงุทู ุงูุชู ุณูุนูุฏ ุงูุณุนุฑ ูุชุบุทูุชูุง)

๐ฏ*ุงูุฅุดุงุฑุฉ ุงูุชูููุฐูุฉ*:
-*ุงูุณุนุฑ ุงูุญุงูู*:[ุงุฐูุฑ ุงูุณุนุฑ ุงูุฏููู ุงูุฐู ุชุฑุงู ุงูุขู ููุชุฃูุฏ ูู ุฏูุฉ ุงููุฑุงุกุฉ]
-*ุญุงูุฉ ุงูุดูุนุฉ*:[ูุงุฒุงูุช ููุชูุญุฉ / ูุบููุฉ ุญุฏูุซุงู]
-*ุงููุฑุงุฑ ุงูููู*:(ุดุฑุงุก ๐ข / ุจูุน ๐ด/ ุงูุฅุญุชูุงุธ ๐ก)
-*ููุฉ ุงูุฅุดุงุฑุฉ ๐ฐ*:(ุนุงููุฉ ุฌุฏุง ๐ฅ (ูุคุดุฑุงุช + 5ุชูุงูู)/๐ฅ ุนุงููุฉ (ุชูุงูู 4 ูุคุดุฑุงุช)/โก ูุชูุณุทุฉ (ูุคุดุฑุงุช 3 ุชูุงูู)/โ๏ธ ุถุนููุฉ (ูุคุดุฑุงุช 3 ูู ุชูู))
-*ููุทุฉ ุงูุฏุฎูู (Entry)*:[ุงูุณุนุฑ ุงูุฏููู ุจูุงุกู ุนูู ุงูู Order Block + ุดุฑุท ุงูุฅุบูุงู]
-*ุงูุฃูุฏุงู ุงูุฑุจุญูุฉ (TPs)*:
 - ๐ฏ*TP1*:[ุณุญุจ ุฃูู ุณูููุฉ ุฏุงุฎููุฉ],[ุงุญุชูุงููุฉ ุงููุตูู]
 - ๐ฏ*TP2*:[ุงููุฏู ุงูุฑุฆูุณู- ููุทูุฉ ุนุฑุถ/ุทูุจ ูููุฉ],]
 - ๐ฏ*TP3*:[ุงุณุชูุฏุงู ุงูุณูููุฉ ุงูุฎุงุฑุฌูุฉ (Major SSL/BSL) ุฃู ุณุฏ ูุฌูุฉ ุณุนุฑูุฉ ุนูู ูุฑูู ุฃูุจุฑ]
-*ููู ุงูุฎุณุงุฑุฉ (SL)*:[ุงูุณุนุฑ ูุน 3 ุทุจูุงุช ุญูุงูุฉ]
-*ุงููุฏุฉ ุงููุชููุนุฉ ๐ง*:[ุนุฏุฏ ุงูุฏูุงุฆู ูููุตูู ูููุฏู TP1 ุจูุงุกู ุนูู ููุน ุงูุฒุฎู]
*(ุญุงูุฉ ุงูุฒุฎู:[ุงูุฏูุงุนู/ุถุนูู/ุชุตุญูุญู/ุนุฑุถู] ุจูุงุกู ุนูู ุชูุงูู RSI ูุน ุงูุดููุน)*

โ๏ธ*ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ*:
-*ูุณุชูู ุงูุซูุฉ*:[% ูุน ุฐูุฑ ุนุฏุฏ ุงูุชุงููุฏุงุช]
-*ููุทุฉ ุงูุฅูุบุงุก*:[ุงูุณุนุฑ ุงูุฐู ููุณุฏ ุงูุชุญููู]
        """
        
        payload = {
            "model": GROQ_MODEL,
            "messages": [
                {
                    "role": "user", 
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url", 
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{base64_img}"
                            }
                        }
                    ]
                }
            ],
            "max_tokens": 1500,
            "temperature": 0.3
        }
        
        headers = {
            "Authorization": f"Bearer {GROQ_KEY}",
            "Content-Type": "application/json"
        }
        
        response = requests.post(GROQ_URL, headers=headers, json=payload, timeout=60)
        
        if response.status_code == 200:
            result = response.json()['choices'][0]['message']['content'].strip()
            
            # โ ุชูุธูู ุงููุต ูู ุงูุชูุฑุงุฑ
            result = clean_repeated_text(result)
            
            # โ ุฅุฒุงูุฉ ุฃู ุชูุฑุงุฑ ูุญุชูู
            # ุฅุฒุงูุฉ "### ุชุญููู ุงูุดุงุฑุช ุงููุฑูู" ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
            if "### ุชุญููู ุงูุดุงุฑุช ุงููุฑูู" in result:
                parts = result.split("### ุชุญููู ุงูุดุงุฑุช ุงููุฑูู")
                if len(parts) > 1:
                    result = parts[1].strip()
            
            # ุฅุฒุงูุฉ ุฃู "ูุชุงุฆุฌ ุงููุญุต ุงูููู:" ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
            if "ูุชุงุฆุฌ ุงููุญุต ุงูููู:" in result:
                result = result.replace("ูุชุงุฆุฌ ุงููุญุต ุงูููู:", "๐ **ุงูุชุญููู ุงูููู:**").strip()
            
            keyboard = [["๐ ุชุญููู ุตูุฑุฉ"], ["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู"], ["๐ ุชูุตูุฉ"], ["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]]
            
            # ุชูุณูู ููุช ุงูุตููุฉ ููุนุฑุถ
            time_display = format_trade_time_for_prompt(trade_time)
            
            # โ ุฅุนุฏุงุฏ ุงููุต ุงูููุงุฆู ุจุฏูู ุชูุฑุงุฑ
            full_result = (
                f"โ **ุชู ุงูุชุญููู ุจูุฌุงุญ!**\n"
                f"๐ **ูุชุงุฆุฌ ุชุญููู ุงูุดุงุฑุช:**\n"
                f"โโโโโโโโโโโโโโโโ\n"
                f"{result}\n\n"
                f"๐ **ุงูุฅุนุฏุงุฏุงุช ุงููุณุชุฎุฏูุฉ:**\n"
                f"โข ุณุฑุนุฉ ุงูุดููุน: {candle}\n"
                f"โข {time_display}\n\n"
                f"โโโโโโโโโโโโโโโโ\n"
                f"๐ค **Obeida Trading - ูุธุงู ุงูุชุญููู ุงูููู**"
            )
            
            # ุชูุธูู ุงูููุงุฆู ูู ุงูุชูุฑุงุฑุงุช
            full_result = clean_repeated_text(full_result)
            
            # ุชูุณูู ุงููุชูุฌุฉ ุฅุฐุง ูุงูุช ุทูููุฉ
            if len(full_result) > 4000:
                parts = split_message(full_result, max_length=4000)
                
                # ุฅุฑุณุงู ุงูุฌุฒุก ุงูุฃูู ูุน ุชุนุฏูู ุงูุฑุณุงูุฉ ุงูููุชุธุฑุฉ
                await wait_msg.edit_text(
                    parts[0],
                    parse_mode="Markdown"
                )
                
                # ุฅุฑุณุงู ุงูุฃุฌุฒุงุก ุงููุชุจููุฉ
                for part in parts[1:]:
                    await update.message.reply_text(part, parse_mode="Markdown")
            else:
                await wait_msg.edit_text(
                    full_result,
                    parse_mode="Markdown"
                )
            
            # ุฅุฑุณุงู ุงูุฃุฒุฑุงุฑ
            await update.message.reply_text(
                "๐ **ุงุฎุชุฑ ุงูุฅุฌุฑุงุก ุงูุชุงูู:**",
                reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
            )
        else:
            print(f"Groq Vision API Error: {response.status_code} - {response.text}")
            keyboard = [["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]]
            await wait_msg.edit_text(f"โ **ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุตูุฑุฉ:** {response.status_code}")
            
    except requests.exceptions.Timeout:
        await wait_msg.edit_text("โฑ๏ธ ุชุฌุงูุฒ ุงูููุช ุงููุญุฏุฏ ุฅุฑุณุงู ุงูุตูุฑุฉ. ุญุงูู ูุฑุฉ ุฃุฎุฑู.")
    except Exception as e:
        print(f"ุฎุทุฃ ูู ุชุญููู ุงูุตูุฑุฉ: {e}")
        keyboard = [["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]]
        await wait_msg.edit_text("โ **ุญุฏุซ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุตูุฑุฉ.**\nูุฑุฌู ุงูุชุฃูุฏ ูู ูุถูุญ ุงูุตูุฑุฉ ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.")
    finally:
        if os.path.exists(path):
            os.remove(path)
    
    return MAIN_MENU

# --- ุงูุฏูุงู ุงูุฃุณุงุณูุฉ ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุจุฏุก ุงูุจูุช"""
    keyboard = [
        ["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู", "๐ ุชุญููู ุตูุฑุฉ"],
        ["๐ฌ ุฏุฑุฏุดุฉ", "๐ ุชูุตูุฉ"]
    ]
    
    await update.message.reply_text(
        "๐ **ุฃููุงู ุจู ูู Obeida Trading **\n\n"
        "๐ค **ุงููููุฒุงุช ุงูุฌุฏูุฏุฉ:**\n"
        "โข ุชุญููู ููู ูุชูุฏู ููุดุงุฑุชุงุช\n"
        "โข ๐ ุฏุฑุฏุดุฉ \n"
        "โข ๐ ูุธุงู ุชูุตูุงุช ุฌุงูุฒุฉ\n"
        "โข ุฅุนุฏุงุฏุงุช ุชุฎุตูุต ูุงููุฉ\n"
        "ุงุฎุชุฑ ุฃุญุฏ ุงูุฎูุงุฑุงุช:",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False),
        parse_mode="Markdown"
    )
    return MAIN_MENU

async def handle_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุนุงูุฌุฉ ุงุฎุชูุงุฑุงุช ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"""
    user_message = update.message.text
    user_id = update.effective_user.id
    
    if user_message == "โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู":
        keyboard = [CANDLE_SPEEDS[i:i+3] for i in range(0, len(CANDLE_SPEEDS), 3)]
        keyboard.append(["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"])
        
        await update.message.reply_text(
            "โ๏ธ **ุฅุนุฏุงุฏุงุช ุงูุชุญููู ุงูููู**\n\n"
            "ุญุฏุฏ ุณุฑุนุฉ ุงูุดููุน ููุจุฏุก:",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
        )
        return SETTINGS_CANDLE
    
    elif user_message == "๐ ุชุญููู ุตูุฑุฉ":
        candle, trade_time = get_user_setting(user_id)
        
        if not candle or not trade_time:
            keyboard = [["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู"], ["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]]
            await update.message.reply_text(
                "โ **ูุฌุจ ุถุจุท ุงูุฅุนุฏุงุฏุงุช ุฃููุงู**\n\n"
                "ุงูุฑุฌุงุก ุถุจุท ุณุฑุนุฉ ุงูุดููุน ููุฏุฉ ุงูุตููุฉ ูุจู ุงูุชุญููู.",
                reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False),
                parse_mode="Markdown"
            )
            return MAIN_MENU
        else:
            keyboard = [["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]]
            
            time_display = format_trade_time_for_prompt(trade_time)
            
            await update.message.reply_text(
                f"๐ **ุฌุงูุฒ ููุชุญููู**\n\n"
                f"ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ:\n"
                f"โข ุณุฑุนุฉ ุงูุดููุน: {candle}\n"
                f"โข {time_display}\n\n"
                f"ุฃุฑุณู ุตูุฑุฉ ุงูุฑุณู ุงูุจูุงูู (ุงูุดุงุฑุช) ุงูุขู:",
                reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False),
                parse_mode="Markdown"
            )
            return ANALYZE_MODE
    
    elif user_message == "๐ฌ ุฏุฑุฏุดุฉ":
        return await start_chat_mode(update, context)
    
    elif user_message == "๐ ุชูุตูุฉ":
        return await start_recommendation_mode(update, context)
    
    keyboard = [["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู", "๐ ุชุญููู ุตูุฑุฉ"], ["๐ฌ ุฏุฑุฏุดุฉ", "๐ ุชูุตูุฉ"]]
    await update.message.reply_text(
        "ุงุฎุชุฑ ุฃุญุฏ ุงูุฎูุงุฑุงุช ูู ุงููุงุฆูุฉ:",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
    )
    return MAIN_MENU

async def handle_settings_candle(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุนุงูุฌุฉ ุงุฎุชูุงุฑ ุณุฑุนุฉ ุงูุดููุน"""
    user_message = update.message.text
    user_id = update.effective_user.id
    
    if user_message == "ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ":
        keyboard = [["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู", "๐ ุชุญููู ุตูุฑุฉ"], ["๐ฌ ุฏุฑุฏุดุฉ", "๐ ุชูุตูุฉ"]]
        await update.message.reply_text(
            "๐ ุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
        )
        return MAIN_MENU
    
    if user_message in CANDLE_SPEEDS:
        save_user_setting(user_id, "candle", user_message)
        
        keyboard = [TRADE_TIMES[i:i+2] for i in range(0, len(TRADE_TIMES), 2)]
        keyboard.append(["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"])
        
        await update.message.reply_text(
            f"โ **ุชู ุชุนููู ุณุฑุนุฉ ุงูุดููุน:** {user_message}\n\n"
            f"ุงูุขู ุญุฏุฏ **ูุฏุฉ ุงูุตููุฉ** ุงููุชููุนุฉ:\n\n"
            f"๐ **ุฎูุงุฑุงุช ูุฏุฉ ุงูุตููุฉ:**\n"
            f"โข **ูุตูุฑ (1m-15m)**: ุชูููุฐ ุณุฑูุนุ ูุฎุงุทุฑ ููุฎูุถุฉ\n"
            f"โข **ูุชูุณุท (4h-Daily)**: ุงูุชุธุงุฑ ุฃูุงูุ ูุฎุงุทุฑ ูุชูุณุทุฉ\n"
            f"โข **ุทููู (Weekly-Monthly)**: ุงุณุชุซูุงุฑ ุทูููุ ูุฎุงุทุฑ ูุฑุชูุนุฉ\n\n"
            f"ุงุฎุชุฑ ุงูุฅุทุงุฑ ุงูุฒููู ุงูููุงุณุจ ูุงุณุชุฑุงุชูุฌูุชู:",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False),
            parse_mode="Markdown"
        )
        return SETTINGS_TIME
    
    await update.message.reply_text("โ ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุณุฑุนุฉ ุดููุน ุตุญูุญุฉ.")
    return SETTINGS_CANDLE

async def handle_settings_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุนุงูุฌุฉ ุงุฎุชูุงุฑ ูุฏุฉ ุงูุตููุฉ"""
    user_message = update.message.text
    user_id = update.effective_user.id
    
    if user_message == "ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ":
        keyboard = [["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู", "๐ ุชุญููู ุตูุฑุฉ"], ["๐ฌ ุฏุฑุฏุดุฉ", "๐ ุชูุตูุฉ"]]
        await update.message.reply_text(
            "๐ ุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
        )
        return MAIN_MENU
    
    if user_message in TRADE_TIMES:
        save_user_setting(user_id, "trade_time", user_message)
        
        keyboard = [["๐ ุชุญููู ุตูุฑุฉ"], ["๐ฌ ุฏุฑุฏุดุฉ"], ["๐ ุชูุตูุฉ"], ["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]]
        
        candle, _ = get_user_setting(user_id)
        
        await update.message.reply_text(
            f"๐ **ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ!**\n\n"
            f"โ ุณุฑุนุฉ ุงูุดููุน: {candle}\n"
            f"โ ูุฏุฉ ุงูุตููุฉ: {user_message}\n\n"
            f"ููููู ุงูุขู ุชุญููู ุตูุฑุฉ ุฃู ุงูุฏุฑุฏุดุฉ:",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False),
            parse_mode="Markdown"
        )
        return MAIN_MENU
    
    await update.message.reply_text("โ ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุฏุฉ ุตููุฉ ุตุญูุญุฉ.")
    return SETTINGS_TIME

async def handle_analyze_mode(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุนุงูุฌุฉ ูุถุน ุงูุชุญููู"""
    user_message = update.message.text
    user_id = update.effective_user.id
    
    if user_message == "ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ":
        keyboard = [["โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุญููู", "๐ ุชุญููู ุตูุฑุฉ"], ["๐ฌ ุฏุฑุฏุดุฉ", "๐ ุชูุตูุฉ"]]
        await update.message.reply_text(
            "๐ ุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
        )
        return MAIN_MENU
    
    await update.message.reply_text(
        "๐ค **ุงูุฑุฌุงุก ุฅุฑุณุงู ุตูุฑุฉ ุงูุดุงุฑุช ููุท**\nุฃู ุงุถุบุท 'ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ'",
        reply_markup=ReplyKeyboardMarkup([["ุงูุฑุฌูุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"]], resize_keyboard=True, one_time_keyboard=False)
    )
    return ANALYZE_MODE

async def handle_photo_in_analyze_mode(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ูุนุงูุฌุฉ ุงูุตูุฑ ูู ูุถุน ุงูุชุญููู"""
    return await handle_photo_analysis(update, context)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุฃูุฑ ุงููุณุงุนุฏุฉ"""
    help_text = """
    ๐ค **ุฃูุงูุฑ ุงูุจูุช:**
    
    /start - ุจุฏุก ุงูุจูุช ูุงูุนูุฏุฉ ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
    /help - ุนุฑุถ ุฑุณุงูุฉ ุงููุณุงุนุฏุฉ
    
    โ๏ธ **ููููุฉ ุงูุงุณุชุฎุฏุงู:**
    1. ุงุณุชุฎุฏู ุฃุฒุฑุงุฑ ุงููุงุฆูุฉ ููุชููู
    2. ุฃุฑุณู ุตูุฑุฉ ุงูุดุงุฑุช ููุชุญููู
    3. ุงุฎุชุฑ "ุฏุฑุฏุดุฉ" ููุงุณุชูุณุงุฑุงุช ุงููุตูุฉ
    4. ุงุฎุชุฑ "ุชูุตูุฉ" ูุชุญููู ุงูุนููุงุช
    
    ๐ **ูุธุงู ุงูุชูุตูุงุช:**
    โข ุชุญููู ููู ููุนููุงุช ูุงููุคุดุฑุงุช
    โข ุฃุฑุจุนุฉ ุฃูุณุงู ุฑุฆูุณูุฉ
    โข ุชูุตูุงุช ููุตูุฉ ููู ุนููุฉ
    โข ุชุญููู ุณุฑูุน ููุจุงุดุฑ
    
    โฑ๏ธ **ุฎูุงุฑุงุช ูุฏุฉ ุงูุตููุฉ:**
    โข **ูุตูุฑ (1m-15m)**: ุชูููุฐ ุณุฑูุนุ ูุฎุงุทุฑ ููุฎูุถุฉ
    โข **ูุชูุณุท (4h-Daily)**: ุงูุชุธุงุฑ ุฃูุงูุ ูุฎุงุทุฑ ูุชูุณุทุฉ
    โข **ุทููู (Weekly-Monthly)**: ุงุณุชุซูุงุฑ ุทูููุ ูุฎุงุทุฑ ูุฑุชูุนุฉ
    
    ๐ **ูููุฒุงุช ุงูุจูุช:**
    โข ุชุญููู ููู ููุฑุณูู ุงูุจูุงููุฉ
    โข ุฏุฑุฏุดุฉ ุฐููุฉ ูุน ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    โข ูุธุงู ุชูุตูุงุช ุงูุนููุงุช
    โข ุญูุธ ุฅุนุฏุงุฏุงุชู ุงูุดุฎุตูุฉ
    โข ูุงุฌูุฉ ุณููุฉ ุจุงูุฃุฒุฑุงุฑ
    """
    await update.message.reply_text(help_text, parse_mode="Markdown")

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุฅูุบุงุก ุงููุญุงุฏุซุฉ"""
    await update.message.reply_text(
        "ุชู ุงูุฅูุบุงุก. ุงูุชุจ /start ููุจุฏุก ูู ุฌุฏูุฏ.",
        reply_markup=ReplyKeyboardRemove()
    )
    return ConversationHandler.END

# --- ุงูุญู ุงูููุงุฆู ---
def run_flask_server():
    """ุชุดุบูู Flask server"""
    port = int(os.environ.get('PORT', 8080))
    app.run(host='0.0.0.0', port=port, debug=False, use_reloader=False)

def run_telegram_bot():
    """ุชุดุบูู Telegram bot"""
    print("๐ค Starting Telegram Bot...")
    
    # ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    init_db()
    
    # ุฅูุดุงุก ุชุทุจูู Telegram
    application = Application.builder().token(TOKEN).build()
    
    # ูุนุงูุฌ ุงููุญุงุฏุซุฉ
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            MAIN_MENU: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_main_menu)
            ],
            SETTINGS_CANDLE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_settings_candle)
            ],
            SETTINGS_TIME: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_settings_time)
            ],
            CHAT_MODE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_chat_message)
            ],
            ANALYZE_MODE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_analyze_mode),
                MessageHandler(filters.PHOTO, handle_photo_in_analyze_mode)
            ],
            RECOMMENDATION_MODE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_recommendation_selection)
            ],
            CATEGORY_SELECTION: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_recommendation_selection)
            ],
        },
        fallbacks=[CommandHandler('start', start), CommandHandler('cancel', cancel)],
        allow_reentry=True
    )
    
    application.add_handler(conv_handler)
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("cancel", cancel))
    
    # ุฅุถุงูุฉ ูุนุงูุฌ ูููุตูุต
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_main_menu))
    
    print("โ Telegram Bot initialized successfully")
    print("๐ก Bot is now polling for updates...")
    
    # ุชุดุบูู ุงูุจูุช
    application.run_polling(allowed_updates=Update.ALL_TYPES, drop_pending_updates=True)

def main():
    """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ"""
    print("๐ Starting Obeida Trading...")
    
    # ุชุดุบูู Flask ูู thread ูููุตู
    flask_thread = threading.Thread(target=run_flask_server, daemon=True)
    flask_thread.start()
    
    print(f"๐ Flask server started on port {os.environ.get('PORT', 8080)}")
    
    # ุชุดุบูู Telegram bot ูู thread ุงูุฑุฆูุณู
    run_telegram_bot()

if __name__ == "__main__":
    main()
